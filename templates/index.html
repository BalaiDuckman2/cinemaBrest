{% extends 'base.html' %}

{% block body %}

<!-- Bouton retour en haut -->
<button id="scrollTopBtn" onclick="scrollToTop()" class="fixed bottom-4 right-4 md:bottom-8 md:right-8 bg-indigo-600 hover:bg-indigo-700 text-white p-3 md:p-4 rounded-full shadow-lg transition-all duration-300 hover:scale-110 z-50 opacity-0 pointer-events-none">
    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
    </svg>
</button>

<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8 max-w-7xl">
    
    <!-- Navigation entre semaines -->
    <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl md:rounded-2xl p-3 sm:p-5 mb-4 sm:mb-6">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4">
            <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto justify-between sm:justify-center">
                <button onclick="changeWeek(-1)" class="px-3 sm:px-6 py-2 sm:py-2.5 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 rounded-lg sm:rounded-xl text-white text-sm sm:text-base font-medium transition-all duration-200 hover:-translate-x-1">
                    <span class="hidden sm:inline">← Précédent</span>
                    <span class="sm:hidden">←</span>
                </button>
                <div id="weekPeriod" class="px-3 sm:px-8 py-2 sm:py-2.5 bg-indigo-600/20 border border-indigo-500/30 rounded-lg sm:rounded-xl text-white text-xs sm:text-base font-semibold text-center flex-1 sm:flex-none">
                    <span class="hidden sm:inline">📅 </span>{{ week_period }}
                </div>
                <button onclick="changeWeek(1)" class="px-3 sm:px-6 py-2 sm:py-2.5 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 rounded-lg sm:rounded-xl text-white text-sm sm:text-base font-medium transition-all duration-200 hover:translate-x-1">
                    <span class="hidden sm:inline">Suivant →</span>
                    <span class="sm:hidden">→</span>
                </button>
            </div>
            <button id="todayBtn" onclick="goToToday()" class="hidden px-3 sm:px-4 py-2 sm:py-2.5 bg-indigo-600 hover:bg-indigo-700 border border-indigo-500 rounded-lg sm:rounded-xl text-white text-sm sm:text-base font-medium transition-all duration-200 hover:scale-105 shadow-lg">
                <span class="hidden sm:inline">🎬 Aujourd'hui</span>
                <span class="sm:hidden">Aujourd'hui</span>
            </button>
        </div>
    </div>

    <!-- Filtres -->
    <div class="bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-md border border-white/20 rounded-xl md:rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 shadow-xl">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-white/90 text-sm sm:text-base font-semibold">🎯 Filtres & Recherche</h3>
            <button onclick="toggleViewMode()" class="flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/15 border border-white/20 rounded-lg text-white text-xs sm:text-sm font-medium transition">
                <svg id="viewIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
                <span id="viewModeText">Vue compacte</span>
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
            <!-- Tri -->
            <div>
                <label for="sortSelect" class="block text-white/90 text-xs sm:text-sm font-semibold mb-1.5 sm:mb-2">📊 Trier par</label>
                <select id="sortSelect" onchange="sortFilms(this.value)" class="w-full px-3 sm:px-4 py-2 sm:py-2.5 bg-white/10 border border-white/20 rounded-lg sm:rounded-xl text-white text-sm sm:text-base font-medium focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition cursor-pointer hover:bg-white/15">
                    <option value="popularity" selected>⭐ Popularité</option>
                    <option value="alphabetical">🔤 Alphabétique (A→Z)</option>
                    <option value="year-desc">📅 Plus récent</option>
                    <option value="year-asc">📅 Plus ancien</option>
                    <option value="showtimes">🎬 Nombre de séances</option>
                </select>
            </div>

            <!-- Version VO/VF -->
            <div>
                <label for="versionSelect" class="block text-white/90 text-xs sm:text-sm font-semibold mb-1.5 sm:mb-2">🎬 Version</label>
                <select id="versionSelect" onchange="filterByVersion(this.value)" class="w-full px-3 sm:px-4 py-2 sm:py-2.5 bg-white/10 border border-white/20 rounded-lg sm:rounded-xl text-white text-sm sm:text-base font-medium focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition cursor-pointer hover:bg-white/15">
                    <option value="all" selected>Toutes</option>
                    <option value="VF">VF uniquement</option>
                    <option value="VO">VO/VOST uniquement</option>
                </select>
            </div>

            <!-- Recherche -->
            <div>
                <label for="searchInput" class="block text-white/90 text-xs sm:text-sm font-semibold mb-1.5 sm:mb-2">🔍 Recherche</label>
                <input type="text" 
                       id="searchInput" 
                       oninput="searchFilms()" 
                       placeholder="Rechercher un film..." 
                       class="w-full px-3 sm:px-4 py-2 sm:py-2.5 bg-white/10 border border-white/20 rounded-lg sm:rounded-xl text-white text-sm sm:text-base font-medium placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition hover:bg-white/15">
            </div>
        </div>
        
        <!-- Filtres supplémentaires (ligne 2) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 mt-3 sm:mt-4">
            <!-- Films Classiques -->
            <div>
                <label for="ageSelect" class="block text-white/90 text-xs sm:text-sm font-semibold mb-1.5 sm:mb-2">📅 Films classiques</label>
                <select id="ageSelect" onchange="changeAgeFilter(parseInt(this.value))" class="w-full px-3 sm:px-4 py-2 sm:py-2.5 bg-white/10 border border-white/20 rounded-lg sm:rounded-xl text-white text-sm sm:text-base font-medium focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-transparent transition cursor-pointer hover:bg-white/15">
                    <option value="0" {% if min_age == 0 %}selected{% endif %}>Tous les films</option>
                    <option value="1" {% if min_age == 1 %}selected{% endif %}>+ 1 an</option>
                    <option value="5" {% if min_age == 5 %}selected{% endif %}>+ 5 ans</option>
                    <option value="30" {% if min_age == 30 %}selected{% endif %}>+ 30 ans</option>
                </select>
            </div>
        </div>
        
        <!-- Résultats de recherche -->
        <p id="searchResults" class="text-xs sm:text-sm text-white/70 mt-2 sm:mt-3 font-medium"></p>
    </div>

    <!-- Filtre par Cinéma -->
    <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-xl md:rounded-2xl p-4 sm:p-5 mb-6 sm:mb-8">
        <label class="block text-white/90 text-xs sm:text-sm font-semibold mb-3 sm:mb-4">🎭 Filtrer par cinéma</label>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 sm:gap-3">
            <label class="cinema-checkbox-label flex items-center gap-2 sm:gap-3 px-3 sm:px-4 py-2.5 sm:py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg sm:rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="Les Studios" checked onchange="filterByCinema()" class="w-4 h-4 sm:w-5 sm:h-5 rounded accent-indigo-500 flex-shrink-0">
                <span class="cinema-name text-white/90 font-medium text-xs sm:text-sm">Les Studios</span>
            </label>
            <label class="cinema-checkbox-label flex items-center gap-2 sm:gap-3 px-3 sm:px-4 py-2.5 sm:py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg sm:rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="CGR Brest Le Celtic" checked onchange="filterByCinema()" class="w-4 h-4 sm:w-5 sm:h-5 rounded accent-indigo-500 flex-shrink-0">
                <span class="cinema-name text-white/90 font-medium text-xs sm:text-sm">CGR Brest Le Celtic</span>
            </label>
            <label class="cinema-checkbox-label flex items-center gap-2 sm:gap-3 px-3 sm:px-4 py-2.5 sm:py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg sm:rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="Multiplexe Liberté" checked onchange="filterByCinema()" class="w-4 h-4 sm:w-5 sm:h-5 rounded accent-indigo-500 flex-shrink-0">
                <span class="cinema-name text-white/90 font-medium text-xs sm:text-sm">Multiplexe Liberté</span>
            </label>
            <label class="cinema-checkbox-label flex items-center gap-2 sm:gap-3 px-3 sm:px-4 py-2.5 sm:py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg sm:rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="Pathé Capucins" checked onchange="filterByCinema()" class="w-4 h-4 sm:w-5 sm:h-5 rounded accent-indigo-500 flex-shrink-0">
                <span class="cinema-name text-white/90 font-medium text-xs sm:text-sm">Pathé Capucins</span>
            </label>
            <label class="cinema-checkbox-label flex items-center gap-2 sm:gap-3 px-3 sm:px-4 py-2.5 sm:py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg sm:rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="Ciné Galaxy" checked onchange="filterByCinema()" class="w-4 h-4 sm:w-5 sm:h-5 rounded accent-indigo-500 flex-shrink-0">
                <span class="cinema-name text-white/90 font-medium text-xs sm:text-sm">Ciné Galaxy</span>
            </label>
        </div>
    </div>

    <!-- Liste des films -->
    <div id="filmsContainer" class="space-y-4 sm:space-y-8 transition-opacity duration-200">
    {% for film in films %}
    <div class="film-item bg-white/5 backdrop-blur-md border border-white/10 rounded-xl md:rounded-2xl overflow-hidden hover:border-white/20 transition-all duration-300" 
         data-title="{{ film.title }}" 
         data-year="{{ film.releaseYear or 0 }}"
         data-popularity="{{ film.wantToSee or 0 }}"
         data-showtimes="{{ film.total_showtimes or 0 }}">
        
        <!-- En-tête du film -->
        <div class="flex flex-col md:flex-row gap-4 sm:gap-6 p-4 sm:p-6">
            <img src="{{ film.affiche }}" alt="{{ film.title }}" class="w-full md:w-48 h-auto rounded-lg sm:rounded-xl shadow-lg object-cover">
            
            <div class="flex-1 space-y-3 sm:space-y-4">
                <div>
                    <h3 class="text-xl sm:text-2xl md:text-3xl font-bold text-white mb-2">
                        <a href="{{ film.url }}" class="hover:text-indigo-400 transition">{{ film.title }}</a>
                        {% if film.releaseYear %}
                        <span class="text-sm sm:text-base text-white/40 font-normal ml-2">({{ film.releaseYear }})</span>
                        {% endif %}
                    </h3>
                    {% if film.releaseYear and film.filmAge %}
                    <span class="inline-flex items-center gap-1.5 sm:gap-2 bg-white/10 text-white/70 px-2.5 sm:px-3 py-1 sm:py-1.5 rounded-lg text-xs sm:text-sm font-medium border border-white/10">
                        <span class="opacity-60">📅</span> Il y a {{ film.filmAge }} ans
                    </span>
                    {% endif %}
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 text-xs sm:text-sm">
                    <p class="text-white/70"><span class="font-semibold text-white/90">Réalisateur:</span> {{ film.director }}</p>
                    <p class="text-white/70"><span class="font-semibold text-white/90">Durée:</span> {{ film.duree }}</p>
                    <p class="text-white/70 sm:col-span-2"><span class="font-semibold text-white/90">Genre:</span> {{ film.genres }}</p>
                    <p class="text-white/70 sm:col-span-2"><span class="font-semibold text-white/90">Casting:</span> {{ film.casting }}</p>
                </div>
                
                {% if film.synopsis %}
                <p class="text-white/60 text-xs sm:text-sm leading-relaxed line-clamp-3">{{ film.synopsis }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Tableau des séances -->
        <div class="overflow-x-auto -mx-4 sm:mx-0">
            <table class="w-full border-collapse min-w-max">
                <thead>
                    <tr class="bg-white/5">
                        <th class="px-2 sm:px-4 py-3 sm:py-4 text-left text-white/90 font-semibold border-r border-white/10 text-xs sm:text-sm sticky left-0 bg-gray-900/90 backdrop-blur-sm z-10">Cinéma</th>
                        {% for date in dates %}
                        <th class="px-2 sm:px-3 py-3 sm:py-4 text-center border-r border-white/5 min-w-[80px] sm:min-w-[100px]">
                            <div class="text-white/50 text-[10px] sm:text-xs font-normal">{{ date.jour }}</div>
                            <div class="text-lg sm:text-xl font-bold text-white/90 my-0.5 sm:my-1">{{ date.chiffre }}</div>
                            <div class="text-white/50 text-[10px] sm:text-xs font-normal">{{ date.mois }}</div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for cinema_name, days_data in film.seances_table.items() %}
                    <tr class="cinema-row border-t border-white/5 hover:bg-white/5 transition" data-cinema="{{ cinema_name }}">
                        <td class="px-2 sm:px-4 py-2 sm:py-3 text-white/85 font-medium border-r border-white/10 text-xs sm:text-sm sticky left-0 bg-gray-900/90 backdrop-blur-sm z-10">
                            {{ cinema_name }}
                        </td>
                        {% for date in dates %}
                        <td class="px-1 sm:px-2 py-2 sm:py-3 text-center border-r border-white/5">
                            {% if date.index in days_data %}
                            <div class="flex flex-wrap gap-1 sm:gap-1.5 justify-center">
                                {% for showtime in days_data[date.index] %}
                                <div class="relative inline-block group">
                                    <button 
                                        onclick="handleShowtimeClick('{{ film.title }}', '{{ cinema_name }}', '{{ date.date }}', '{{ showtime.time }}', '{{ film.url }}', '{{ film.affiche }}', '{{ showtime.version }}')"
                                        data-film="{{ film.title }}"
                                        data-cinema="{{ cinema_name }}"
                                        data-date="{{ date.date }}"
                                        data-time="{{ showtime.time }}"
                                        data-version="{{ showtime.version }}"
                                        class="showtime-slot bg-white/15 hover:bg-white/25 text-white px-1.5 sm:px-2.5 py-0.5 sm:py-1 rounded text-[10px] sm:text-xs font-medium border border-white/20 whitespace-nowrap transition cursor-pointer flex flex-col items-center gap-0.5">
                                        <span class="font-semibold">{{ showtime.time }}</span>
                                        <span class="text-[8px] sm:text-[10px] opacity-70">{{ showtime.version }}</span>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="text-white/20 text-xs sm:text-sm">—</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
    </div>

</div>

<style>
/* Styles pour les select dropdowns */
select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
}

select option {
    background-color: #1f2937;
    color: white;
}
</style>

<script>
// Fonction pour remonter en haut avec défilement smooth
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Gérer l'affichage du bouton scroll to top
const scrollTopBtn = document.getElementById('scrollTopBtn');

window.addEventListener('scroll', function() {
    if (window.scrollY > 300) {
        scrollTopBtn.classList.remove('opacity-0', 'pointer-events-none');
        scrollTopBtn.classList.add('opacity-100');
    } else {
        scrollTopBtn.classList.add('opacity-0', 'pointer-events-none');
        scrollTopBtn.classList.remove('opacity-100');
    }
});

// Variable globale pour suivre la semaine actuelle
let currentWeekOffset = {{ week_offset }};
let currentMinAge = {{ min_age }};
let isLoading = false;
let isCompactView = localStorage.getItem('compactView') === 'true';

// Initialiser les préférences sauvegardées au chargement
window.addEventListener('DOMContentLoaded', function() {
    // Restaurer le filtre d'âge sauvegardé
    const savedMinAge = localStorage.getItem('minAge');
    if (savedMinAge !== null) {
        document.getElementById('ageSelect').value = savedMinAge;
    }
    
    // Restaurer le tri sauvegardé
    const savedSort = localStorage.getItem('sortBy');
    if (savedSort) {
        document.getElementById('sortSelect').value = savedSort;
        sortFilms(savedSort);
    }
    
    // Restaurer les cinémas sélectionnés
    const savedCinemas = localStorage.getItem('selectedCinemas');
    if (savedCinemas) {
        const cinemasList = JSON.parse(savedCinemas);
        document.querySelectorAll('.cinema-checkbox-label input').forEach(checkbox => {
            checkbox.checked = cinemasList.includes(checkbox.value);
        });
        filterByCinema();
    }
    
    // Restaurer la vue compacte/étendue
    if (isCompactView) {
        applyCompactView();
    }
    
    // Afficher le bouton "Aujourd'hui" si on n'est pas sur la semaine actuelle
    updateTodayButton();
});

// Fonction pour retourner à la semaine actuelle
function goToToday() {
    if (currentWeekOffset !== 0) {
        changeWeek(-currentWeekOffset);
    }
}

// Mettre à jour l'affichage du bouton "Aujourd'hui"
function updateTodayButton() {
    const todayBtn = document.getElementById('todayBtn');
    if (currentWeekOffset !== 0) {
        todayBtn.classList.remove('hidden');
    } else {
        todayBtn.classList.add('hidden');
    }
}

// Toggle entre vue compacte et étendue
function toggleViewMode() {
    isCompactView = !isCompactView;
    localStorage.setItem('compactView', isCompactView);
    
    if (isCompactView) {
        applyCompactView();
    } else {
        applyExtendedView();
    }
}

// Appliquer la vue compacte
function applyCompactView() {
    const viewIcon = document.getElementById('viewIcon');
    const viewModeText = document.getElementById('viewModeText');
    
    viewModeText.textContent = 'Vue étendue';
    viewIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>';
    
    document.querySelectorAll('.film-item').forEach(film => {
        // Cacher l'image, synopsis et infos détaillées
        const img = film.querySelector('img');
        const synopsis = film.querySelector('.line-clamp-3');
        const filmInfo = film.querySelector('.grid.grid-cols-1');
        const filmAge = film.querySelector('.inline-flex');
        
        if (img) img.classList.add('hidden');
        if (synopsis) synopsis.classList.add('hidden');
        if (filmInfo) filmInfo.classList.add('hidden');
        if (filmAge) filmAge.classList.add('hidden');
        
        // Réduire le padding
        const header = film.querySelector('.flex.flex-col');
        if (header) {
            header.classList.remove('p-4', 'sm:p-6', 'gap-4', 'sm:gap-6');
            header.classList.add('p-2', 'sm:p-3');
        }
    });
}

// Appliquer la vue étendue
function applyExtendedView() {
    const viewIcon = document.getElementById('viewIcon');
    const viewModeText = document.getElementById('viewModeText');
    
    viewModeText.textContent = 'Vue compacte';
    viewIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>';
    
    document.querySelectorAll('.film-item').forEach(film => {
        // Réafficher tout
        const img = film.querySelector('img');
        const synopsis = film.querySelector('.line-clamp-3');
        const filmInfo = film.querySelector('.grid.grid-cols-1');
        const filmAge = film.querySelector('.inline-flex');
        
        if (img) img.classList.remove('hidden');
        if (synopsis) synopsis.classList.remove('hidden');
        if (filmInfo) filmInfo.classList.remove('hidden');
        if (filmAge) filmAge.classList.remove('hidden');
        
        // Restaurer le padding
        const header = film.querySelector('.flex.flex-col');
        if (header) {
            header.classList.remove('p-2', 'sm:p-3');
            header.classList.add('p-4', 'sm:p-6', 'gap-4', 'sm:gap-6');
        }
    });
}

// Fonction pour changer le filtre d'âge dynamiquement
async function changeAgeFilter(minAge) {
    if (isLoading) return;
    
    isLoading = true;
    currentMinAge = minAge;
    
    // Sauvegarder le filtre d'âge dans localStorage
    localStorage.setItem('minAge', minAge);
    
    try {
        const container = document.getElementById('filmsContainer');
        container.style.opacity = '0.5';
        
        // Récupérer les données via l'API
        const response = await fetch(`/api/films?week=${currentWeekOffset}&age=${currentMinAge}`);
        const data = await response.json();
        
        // Mettre à jour l'URL sans recharger la page
        const newUrl = currentMinAge > 0 ? `/?week=${currentWeekOffset}&age=${currentMinAge}` : `/?week=${currentWeekOffset}`;
        window.history.pushState({week: currentWeekOffset, age: currentMinAge}, '', newUrl);
        
        // Reconstruire le contenu HTML des films
        renderFilms(data.films, data.dates);
        
        container.style.opacity = '1';
        
        // Réappliquer les filtres et tri sauvegardés
        restoreCinemaPreferences();
        
        const savedSearch = localStorage.getItem('searchTerm');
        if (savedSearch) {
            document.getElementById('searchInput').value = savedSearch;
            searchFilms();
        }
        
        const savedSort = localStorage.getItem('sortType');
        if (savedSort) {
            sortFilms(savedSort);
        } else {
            sortFilms('popularity');
        }
        
    } catch (error) {
        console.error('Erreur lors du changement de filtre:', error);
        alert('Erreur lors du chargement des données');
        container.style.opacity = '1';
    } finally {
        isLoading = false;
    }
}

// Fonction pour changer de semaine dynamiquement
async function changeWeek(offset) {
    if (isLoading) return;
    
    isLoading = true;
    currentWeekOffset += offset;
    
    try {
        const container = document.getElementById('filmsContainer');
        container.style.opacity = '0.5';
        
        const response = await fetch(`/api/films?week=${currentWeekOffset}&age=${currentMinAge}`);
        const data = await response.json();
        
        document.getElementById('weekPeriod').innerHTML = `<span class="hidden sm:inline">📅 </span>${data.week_period}`;
        
        const newUrl = `/?week=${currentWeekOffset}&age=${currentMinAge}`;
        window.history.pushState({week: currentWeekOffset}, '', newUrl);
        
        renderFilms(data.films, data.dates);
        
        // Mettre à jour le bouton "Aujourd'hui"
        updateTodayButton();
        
        container.style.opacity = '1';
        
        restoreCinemaPreferences();
        
        const savedSearch = localStorage.getItem('searchTerm');
        if (savedSearch) {
            document.getElementById('searchInput').value = savedSearch;
            searchFilms();
        }
        
        const savedSort = localStorage.getItem('sortType');
        if (savedSort) {
            sortFilms(savedSort);
        } else {
            sortFilms('popularity');
        }
        
    } catch (error) {
        console.error('Erreur lors du changement de semaine:', error);
        alert('Erreur lors du chargement des données');
        container.style.opacity = '1';
    } finally {
        isLoading = false;
    }
}

// Fonction de recherche de films en temps réel
function searchFilms() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase().trim();
    const filmItems = document.querySelectorAll('.film-item');
    const resultsText = document.getElementById('searchResults');
    
    localStorage.setItem('searchTerm', input.value);
    
    let visibleCount = 0;
    
    filmItems.forEach(filmItem => {
        const filmText = filmItem.textContent.toLowerCase();
        
        if (filter === '' || filmText.includes(filter)) {
            filmItem.style.display = '';
            visibleCount++;
        } else {
            filmItem.style.display = 'none';
        }
    });
    
    if (filter === '') {
        resultsText.textContent = '';
    } else {
        resultsText.textContent = `${visibleCount} film(s) trouvé(s)`;
        resultsText.style.color = visibleCount > 0 ? '#4caf50' : '#f44336';
    }
}

// Fonction de filtre par cinéma
function filterByCinema() {
    const checkboxes = document.querySelectorAll('.cinema-checkbox-label input[type="checkbox"]');
    const selectedCinemas = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    localStorage.setItem('selectedCinemas', JSON.stringify(selectedCinemas));
    
    checkboxes.forEach(checkbox => {
        const label = checkbox.closest('.cinema-checkbox-label');
        if (checkbox.checked) {
            label.classList.add('bg-white/15', 'border-white/30');
        } else {
            label.classList.remove('bg-white/15', 'border-white/30');
        }
    });
    
    document.querySelectorAll('.cinema-row').forEach(row => {
        const cinemaName = row.dataset.cinema;
        if (selectedCinemas.includes(cinemaName)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    document.querySelectorAll('.film-item').forEach(filmItem => {
        const visibleRows = filmItem.querySelectorAll('.cinema-row:not([style*="display: none"])');
        
        if (visibleRows.length === 0) {
            filmItem.style.display = 'none';
        } else {
            filmItem.style.display = '';
        }
    });
}

// Fonction de filtre par version (VO/VF)
let currentVersionFilter = 'all';

function filterByVersion(version) {
    currentVersionFilter = version;
    localStorage.setItem('versionFilter', version);
    
    const filmCards = document.querySelectorAll('.film-card, .film-item');
    
    filmCards.forEach(card => {
        if (version === 'all') {
            // Afficher toutes les séances et toutes les lignes cinéma
            const showtimeSlots = card.querySelectorAll('.showtime-slot');
            showtimeSlots.forEach(slot => {
                slot.parentElement.style.display = '';
            });
            
            const cinemaRows = card.querySelectorAll('.cinema-row');
            cinemaRows.forEach(row => {
                row.style.display = '';
            });
            
            card.style.display = '';
        } else {
            // Filtrer les séances selon la version
            const showtimeSlots = card.querySelectorAll('.showtime-slot');
            
            showtimeSlots.forEach(slot => {
                const slotVersion = slot.dataset.version || '';
                
                if (version === 'VF' && slotVersion === 'VF') {
                    slot.parentElement.style.display = '';
                } else if (version === 'VO' && (slotVersion.includes('VO') || slotVersion.includes('VOST'))) {
                    slot.parentElement.style.display = '';
                } else {
                    slot.parentElement.style.display = 'none';
                }
            });
            
            // Masquer les lignes de cinéma qui n'ont plus de séances visibles
            const cinemaRows = card.querySelectorAll('.cinema-row');
            let hasVisibleRow = false;
            
            cinemaRows.forEach(row => {
                const visibleSlots = row.querySelectorAll('.showtime-slot[style=""], .showtime-slot:not([style*="display: none"])');
                const actuallyVisible = Array.from(visibleSlots).filter(slot => {
                    return slot.parentElement.style.display !== 'none';
                });
                
                if (actuallyVisible.length > 0) {
                    row.style.display = '';
                    hasVisibleRow = true;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Masquer le film si aucune ligne de cinéma n'est visible
            if (hasVisibleRow) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        }
    });
}

// Restaurer les préférences de cinéma au chargement
function restoreCinemaPreferences() {
    const savedCinemas = localStorage.getItem('selectedCinemas');
    
    if (savedCinemas) {
        try {
            const selectedCinemas = JSON.parse(savedCinemas);
            const checkboxes = document.querySelectorAll('.cinema-checkbox-label input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            checkboxes.forEach(checkbox => {
                if (selectedCinemas.includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
            
            filterByCinema();
        } catch (e) {
            console.error('Erreur lors de la restauration des préférences:', e);
        }
    }
}

// Variable pour mémoriser le tri actuel
let currentSort = 'popularity';

// Fonction de tri des films
function sortFilms(sortType) {
    const container = document.getElementById('filmsContainer');
    const films = Array.from(container.querySelectorAll('.film-item'));
    
    // Sauvegarder le tri dans localStorage
    localStorage.setItem('sortBy', sortType);
    currentSort = sortType;
    localStorage.setItem('sortType', sortType);
    
    // Mettre à jour la valeur du select
    document.getElementById('sortSelect').value = sortType;
    
    currentSort = sortType;
    
    films.sort((a, b) => {
        switch(sortType) {
            case 'popularity':
                return parseInt(b.dataset.popularity) - parseInt(a.dataset.popularity);
            
            case 'alphabetical':
                return a.dataset.title.localeCompare(b.dataset.title);
            
            case 'year-desc':
                return parseInt(b.dataset.year) - parseInt(a.dataset.year);
            
            case 'year-asc':
                return parseInt(a.dataset.year) - parseInt(b.dataset.year);
            
            case 'showtimes':
                return parseInt(b.dataset.showtimes) - parseInt(a.dataset.showtimes);
            
            default:
                return 0;
        }
    });
    
    films.forEach(film => container.appendChild(film));
    
    container.style.opacity = '0.7';
    setTimeout(() => {
        container.style.opacity = '1';
    }, 150);
}

// Fonction pour générer le HTML d'un film
function renderFilms(films, dates) {
    const container = document.getElementById('filmsContainer');
    
    if (films.length === 0) {
        container.innerHTML = '<div class="text-center py-16 text-white/60">Aucun film trouvé pour cette semaine</div>';
        return;
    }
    
    container.innerHTML = films.map(film => {
        const datesHeader = dates.map(date => `
            <th class="px-3 py-4 text-center border-r border-white/5">
                <div class="text-white/50 text-xs font-normal">${date.jour}</div>
                <div class="text-xl font-bold text-white/90 my-1">${date.chiffre}</div>
                <div class="text-white/50 text-xs font-normal">${date.mois}</div>
            </th>
        `).join('');
        
        let seancesHTML = '';
        for (const [cinema, days] of Object.entries(film.seances_table || {})) {
            seancesHTML += `
                <tr class="cinema-row border-t border-white/5 hover:bg-white/5 transition" data-cinema="${cinema}">
                    <td class="px-4 py-3 text-white/85 font-medium border-r border-white/10 whitespace-nowrap text-sm">
                        ${cinema}
                    </td>`;
            
            for (let i = 0; i < 7; i++) {
                const times = days[i] || [];
                if (times.length > 0) {
                    seancesHTML += `
                        <td class="px-2 py-3 text-center border-r border-white/5">
                            <div class="flex flex-wrap gap-1.5 justify-center">
                                ${times.map(time => `<span class="bg-white/15 hover:bg-white/20 text-white px-2.5 py-1 rounded-lg text-xs font-medium border border-white/20 whitespace-nowrap transition">${time}</span>`).join('')}
                            </div>
                        </td>`;
                } else {
                    seancesHTML += `<td class="px-2 py-3 text-center border-r border-white/5"><span class="text-white/20 text-sm">—</span></td>`;
                }
            }
            seancesHTML += '</tr>';
        }
        
        const filmAge = film.filmAge || '';
        const releaseYear = film.releaseYear || '';
        
        return `
            <div class="film-item bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden hover:border-white/20 transition-all duration-300" 
                 data-title="${film.title || ''}" 
                 data-year="${releaseYear}"
                 data-popularity="${film.wantToSee || 0}"
                 data-showtimes="${film.total_showtimes || 0}">
                
                <div class="flex flex-col md:flex-row gap-6 p-6">
                    <img src="${film.affiche || ''}" alt="${film.title}" class="w-full md:w-48 h-auto rounded-xl shadow-lg object-cover">
                    
                    <div class="flex-1 space-y-4">
                        <div>
                            <h3 class="text-2xl md:text-3xl font-bold text-white mb-2">
                                <a href="${film.url || '#'}" class="hover:text-indigo-400 transition">${film.title || ''}</a>
                                ${releaseYear ? `<span class="text-base text-white/40 font-normal ml-2">(${releaseYear})</span>` : ''}
                            </h3>
                            ${releaseYear && filmAge ? `
                            <span class="inline-flex items-center gap-2 bg-white/10 text-white/70 px-3 py-1.5 rounded-lg text-sm font-medium border border-white/10">
                                <span class="opacity-60">📅</span> Il y a ${filmAge} ans
                            </span>
                            ` : ''}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <p class="text-white/70"><span class="font-semibold text-white/90">Réalisateur:</span> ${film.director || 'N/A'}</p>
                            <p class="text-white/70"><span class="font-semibold text-white/90">Durée:</span> ${film.duree || 'N/A'}</p>
                            <p class="text-white/70 col-span-2"><span class="font-semibold text-white/90">Genre:</span> ${film.genres || 'N/A'}</p>
                            <p class="text-white/70 col-span-2"><span class="font-semibold text-white/90">Casting:</span> ${film.casting || 'N/A'}</p>
                        </div>
                        
                        ${film.synopsis ? `<p class="text-white/60 text-sm leading-relaxed line-clamp-3">${film.synopsis}</p>` : ''}
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-white/5">
                                <th class="px-4 py-4 text-left text-white/90 font-semibold border-r border-white/10 text-sm">Cinéma</th>
                                ${datesHeader}
                            </tr>
                        </thead>
                        <tbody>
                            ${seancesHTML}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }).join('');
    
    // Réappliquer la vue compacte si nécessaire
    if (isCompactView) {
        setTimeout(() => applyCompactView(), 100);
    }
    
    // Réappliquer le filtre par cinéma
    filterByCinema();
}

// Gérer le bouton retour du navigateur
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.week !== undefined) {
        const offset = event.state.week - currentWeekOffset;
        changeWeek(offset);
    }
});

// Restaurer les préférences au chargement de la page
window.addEventListener('load', () => {
    // Restaurer le filtre d'âge
    const savedMinAge = localStorage.getItem('minAge');
    if (savedMinAge !== null) {
        const minAge = parseInt(savedMinAge);
        if (minAge !== currentMinAge) {
            currentMinAge = minAge;
            document.querySelectorAll('.age-filter').forEach(btn => {
                btn.classList.remove('bg-white', 'text-gray-900', 'border-white');
                btn.classList.add('bg-white/5', 'text-white/80', 'border-white/10');
            });
            const activeBtn = document.querySelector(`.age-filter[onclick="changeAgeFilter(${minAge})"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-white/5', 'text-white/80', 'border-white/10');
                activeBtn.classList.add('bg-white', 'text-gray-900', 'border-white');
            }
        }
    }
    
    // Restaurer les préférences de cinéma
    restoreCinemaPreferences();
    
    // Restaurer la recherche
    const searchInput = document.getElementById('searchInput');
    const savedSearch = localStorage.getItem('searchTerm');
    if (searchInput && savedSearch) {
        searchInput.value = savedSearch;
        searchFilms();
    }
    
    // Restaurer le tri
    const savedSort = localStorage.getItem('sortType');
    if (savedSort) {
        sortFilms(savedSort);
    }
    
    // Restaurer le filtre de version
    const savedVersion = localStorage.getItem('versionFilter');
    if (savedVersion) {
        document.getElementById('versionSelect').value = savedVersion;
        filterByVersion(savedVersion);
    }
});

// Fonction pour ajouter une séance au calendrier
async function addToCalendar(filmTitle, cinema, showtimeDate, showtimeTime, filmUrl, filmPoster, showtimeVersion) {
    try {
        const formData = new FormData();
        formData.append('film_title', filmTitle);
        formData.append('cinema', cinema);
        formData.append('showtime_date', showtimeDate);
        formData.append('showtime_time', showtimeTime);
        formData.append('film_url', filmUrl || '');
        formData.append('film_poster', filmPoster || '');
        formData.append('showtime_version', showtimeVersion || '');
        
        const response = await fetch('/add-to-calendar', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Afficher une notification de succès
            showNotification('✅ Ajouté à votre calendrier !', 'success');
            // Recharger la watchlist pour mettre à jour les couleurs
            await loadWatchlist();
        } else {
            showNotification('⚠️ ' + data.message, 'warning');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showNotification('❌ Erreur lors de l\'ajout', 'error');
    }
}

// Watchlist en mémoire pour coloration rapide
let userWatchlist = [];

// Charger la watchlist de l'utilisateur
async function loadWatchlist() {
    {% if current_user.is_authenticated %}
    try {
        const response = await fetch('/api/my-watchlist');
        if (response.ok) {
            userWatchlist = await response.json();
            colorizeShowtimes();
        }
    } catch (error) {
        console.error('Erreur chargement watchlist:', error);
    }
    {% endif %}
}

// Colorer les horaires selon s'ils sont dans le calendrier
function colorizeShowtimes() {
    document.querySelectorAll('.showtime-slot').forEach(slot => {
        const filmTitle = slot.dataset.film;
        const cinema = slot.dataset.cinema;
        const date = slot.dataset.date;
        const time = slot.dataset.time;
        
        const isInWatchlist = userWatchlist.some(item => 
            item.film_title === filmTitle &&
            item.cinema === cinema &&
            item.showtime_date === date &&
            item.showtime_time === time
        );
        
        if (isInWatchlist) {
            // Horaire déjà dans le calendrier → Couleur verte
            slot.classList.remove('bg-white/15', 'hover:bg-white/25', 'border-white/20');
            slot.classList.add('bg-green-600/40', 'hover:bg-green-600/60', 'border-green-500/50', 'text-green-100');
        } else {
            // Horaire pas dans le calendrier → Couleur normale
            slot.classList.remove('bg-green-600/40', 'hover:bg-green-600/60', 'border-green-500/50', 'text-green-100');
            slot.classList.add('bg-white/15', 'hover:bg-white/25', 'border-white/20');
        }
    });
}

// Gérer le clic sur un horaire
async function handleShowtimeClick(filmTitle, cinema, showtimeDate, showtimeTime, filmUrl, filmPoster, showtimeVersion) {
    {% if current_user.is_authenticated %}
    // Vérifier si déjà dans le calendrier
    const isInWatchlist = userWatchlist.some(item => 
        item.film_title === filmTitle &&
        item.cinema === cinema &&
        item.showtime_date === showtimeDate &&
        item.showtime_time === showtimeTime
    );
    
    if (isInWatchlist) {
        showNotification('ℹ️ Déjà dans votre calendrier', 'info');
    } else {
        // Ajouter au calendrier
        await addToCalendar(filmTitle, cinema, showtimeDate, showtimeTime, filmUrl, filmPoster, showtimeVersion);
    }
    {% else %}
    showNotification('🔒 Connectez-vous pour ajouter au calendrier', 'info');
    {% endif %}
}

// Fonction pour afficher une notification temporaire
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-20 right-4 z-50 p-4 rounded-lg shadow-lg backdrop-blur-md border transition-all duration-300 ${
        type === 'success' ? 'bg-green-500/20 border-green-500/30 text-green-100' :
        type === 'error' ? 'bg-red-500/20 border-red-500/30 text-red-100' :
        type === 'warning' ? 'bg-yellow-500/20 border-yellow-500/30 text-yellow-100' :
        'bg-blue-500/20 border-blue-500/30 text-blue-100'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Animation d'entrée
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Supprimer après 3 secondes
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Charger la watchlist au démarrage
document.addEventListener('DOMContentLoaded', () => {
    loadWatchlist();
});
</script>

{% endblock %}
