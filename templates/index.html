{% extends 'base.html' %}

{% block head %}
<style>
#filmsContainer {
    transition: opacity 0.2s ease-in-out;
}
</style>
{% endblock %}

{% block body %}

<a href="#headerTop">
    <div class="goTop">
        <p>üçø</p>
    </div>
</a>

<img src="../static/images/background.svg" class="background_svg">

<div class="planning">
    <div class="container_titrePlanning">
        <div class="contenu_edt">
            <h2 class="txt_edt">Emploi du temps</h2>
        </div>
        <div class="line"></div>
        
        <!-- Section Filtres et Recherche (Design moderne √©pur√©) -->
        <style>
            .filter-section {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 20px;
                margin: 25px 0 15px 0;
            }
            
            .week-nav-integrated {
                background: rgba(255,255,255,0.02);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 16px;
                padding: 20px 24px;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 20px;
            }
            
            .week-nav-integrated .week-nav-btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 18px;
                background: rgba(255,255,255,0.05);
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 8px;
                color: rgba(255,255,255,0.9);
                font-weight: 500;
                font-size: 0.9rem;
                transition: all 0.2s ease;
                cursor: pointer;
                text-decoration: none;
            }
            
            .week-nav-integrated .week-nav-btn:hover {
                background: rgba(255,255,255,0.1);
                border-color: rgba(255,255,255,0.2);
                transform: translateX(-2px);
            }
            
            .week-nav-integrated .week-nav-btn:last-child:hover {
                transform: translateX(2px);
            }
            
            .week-nav-integrated .week-period {
                flex: 1;
                text-align: center;
                font-size: 1.1rem;
                font-weight: 600;
                color: rgba(255,255,255,0.95);
                letter-spacing: 0.5px;
            }
            
            .search-sort-section {
                background: rgba(255,255,255,0.03);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 16px;
                padding: 24px;
            }
            
            .filter-card {
                background: rgba(255,255,255,0.03);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 16px;
                padding: 24px;
            }
            
            .section-label {
                color: rgba(255,255,255,0.6);
                font-size: 0.75em;
                text-transform: uppercase;
                letter-spacing: 1.5px;
                font-weight: 600;
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .search-input {
                width: 100%;
                padding: 14px 18px;
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 10px;
                background: rgba(0,0,0,0.3);
                color: white;
                font-size: 0.95em;
                outline: none;
                transition: all 0.2s ease;
                font-family: inherit;
            }
            
            .search-input:focus {
                border-color: rgba(255,255,255,0.3);
                background: rgba(0,0,0,0.4);
            }
            
            .search-input::placeholder {
                color: rgba(255,255,255,0.4);
            }
            
            .sort-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-top: 12px;
            }
            
            .sort-btn {
                padding: 10px 14px;
                background: rgba(255,255,255,0.05);
                color: rgba(255,255,255,0.7);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                font-size: 0.85em;
                font-weight: 500;
                font-family: inherit;
            }
            
            .sort-btn:hover {
                background: rgba(255,255,255,0.08);
                color: white;
                border-color: rgba(255,255,255,0.15);
                transform: translateY(-1px);
            }
            
            .sort-btn.active {
                background: white;
                color: #0f1419;
                border-color: white;
            }
            
            .age-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .age-filter {
                padding: 14px;
                background: rgba(255,255,255,0.05);
                color: rgba(255,255,255,0.8);
                text-decoration: none;
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 10px;
                transition: all 0.2s ease;
                text-align: center;
                font-weight: 500;
                font-size: 0.9em;
                cursor: pointer;
                display: block;
                width: 100%;
            }
            
            .age-filter:hover {
                background: rgba(255,255,255,0.08);
                border-color: rgba(255,255,255,0.15);
                transform: translateY(-1px);
            }
            
            .age-filter.active {
                background: white;
                color: #0f1419;
                border-color: white;
            }
            
            .search-results {
                color: rgba(255,255,255,0.5);
                margin-top: 12px;
                font-size: 0.8em;
                min-height: 18px;
            }
            
            /* Filtre cin√©ma */
            .cinema-filter-section {
                background: rgba(255,255,255,0.03);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 16px;
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .cinema-checkbox-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 10px;
                margin-top: 12px;
            }
            
            .cinema-checkbox-label {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 14px;
                background: rgba(255,255,255,0.05);
                border: 1px solid rgba(255,255,255,0.08);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
                user-select: none;
            }
            
            .cinema-checkbox-label:hover {
                background: rgba(255,255,255,0.08);
                border-color: rgba(255,255,255,0.15);
            }
            
            .cinema-checkbox-label input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: white;
            }
            
            .cinema-checkbox-label.active {
                background: rgba(255,255,255,0.15);
                border-color: rgba(255,255,255,0.3);
            }
            
            .cinema-name {
                color: rgba(255,255,255,0.9);
                font-size: 0.9em;
                font-weight: 500;
            }
            
            @media (max-width: 968px) {
                .filter-section {
                    grid-template-columns: 1fr;
                }
                .sort-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
                .cinema-checkbox-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>
        
        <!-- Navigation entre semaines (int√©gr√©e) -->
        <div class="week-nav-integrated">
            <button onclick="changeWeek(-1)" class="week-nav-btn">
                ‚Üê Semaine pr√©c√©dente
            </button>
            <div class="week-period" id="weekPeriod">
                üìÖ {{ week_period }}
            </div>
            <button onclick="changeWeek(1)" class="week-nav-btn">
                Semaine suivante ‚Üí
            </button>
        </div>
        
        <!-- Filtre par cin√©ma -->
        <div class="cinema-filter-section">
            <div class="section-label">
                <span>üé≠</span> Filtrer par cin√©ma
            </div>
            <div class="cinema-checkbox-grid">
                <label class="cinema-checkbox-label active">
                    <input type="checkbox" value="Les Studios" checked onchange="filterByCinema()">
                    <span class="cinema-name">Les Studios</span>
                </label>
                <label class="cinema-checkbox-label active">
                    <input type="checkbox" value="CGR Brest Le Celtic" checked onchange="filterByCinema()">
                    <span class="cinema-name">CGR Brest Le Celtic</span>
                </label>
                <label class="cinema-checkbox-label active">
                    <input type="checkbox" value="Multiplexe Libert√©" checked onchange="filterByCinema()">
                    <span class="cinema-name">Multiplexe Libert√©</span>
                </label>
                <label class="cinema-checkbox-label active">
                    <input type="checkbox" value="Path√© Capucins" checked onchange="filterByCinema()">
                    <span class="cinema-name">Path√© Capucins</span>
                </label>
                <label class="cinema-checkbox-label active">
                    <input type="checkbox" value="Cin√© Galaxy" checked onchange="filterByCinema()">
                    <span class="cinema-name">Cin√© Galaxy</span>
                </label>
            </div>
        </div>
        
        <div class="filter-section">
            <!-- Recherche et Tri -->
            <div class="search-sort-section">
                <div class="section-label">
                    <span>üîç</span> Recherche & Tri
                </div>
                
                <input type="text" 
                       id="searchInput" 
                       class="search-input"
                       placeholder="Rechercher un film, acteur, r√©alisateur..."
                       onkeyup="searchFilms()">
                
                <p id="searchResults" class="search-results"></p>
                
                <div class="sort-grid">
                    <button onclick="sortFilms('popularity')" id="sort-popularity" class="sort-btn active">
                        ‚≠ê Popularit√©
                    </button>
                    <button onclick="sortFilms('alphabetical')" id="sort-alphabetical" class="sort-btn">
                        A ‚Üí Z
                    </button>
                    <button onclick="sortFilms('year-desc')" id="sort-year-desc" class="sort-btn">
                        R√©cent
                    </button>
                    <button onclick="sortFilms('year-asc')" id="sort-year-asc" class="sort-btn">
                        Ancien
                    </button>
                    <button onclick="sortFilms('showtimes')" id="sort-showtimes" class="sort-btn">
                        S√©ances
                    </button>
                </div>
            </div>
            
            <!-- Filtres par √¢ge -->
            <div class="filter-card">
                <div class="section-label">
                    <span>üìÖ</span> Films classiques
                </div>
                
                <div class="age-grid">
                    <button onclick="changeAgeFilter(0)" 
                       class="age-filter {% if min_age == 0 %}active{% endif %}">
                        Tous les films
                    </button>
                    <button onclick="changeAgeFilter(1)" 
                       class="age-filter {% if min_age == 1 %}active{% endif %}">
                        +1 an
                    </button>
                    <button onclick="changeAgeFilter(5)" 
                       class="age-filter {% if min_age == 5 %}active{% endif %}">
                        +5 ans
                    </button>
                    <button onclick="changeAgeFilter(30)" 
                       class="age-filter {% if min_age == 30 %}active{% endif %}">
                        +30 ans
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="filmsContainer">
    {% for film in films %}
    <div class="film-item" 
         data-title="{{ film.title }}" 
         data-year="{{ film.releaseYear or 0 }}"
         data-popularity="{{ film.wantToSee or 0 }}"
         data-showtimes="{{ film.total_showtimes or 0 }}">
        
        <div class="container_infoFilm">
            <img src={{ film.affiche }} class="affiche" />
            <div class="infoFilm">
                <div class="blur-background"></div>
                <div>
                    <h3 class="titreFilm">
                        <a href="{{ film.url }}">{{film.title}}</a>
                        {% if film.releaseYear %}
                        <span style="font-size: 0.75em; color: rgba(255,255,255,0.4); font-weight: 400; margin-left: 8px;">({{ film.releaseYear }})</span>
                        {% endif %}
                    </h3>
                    {% if film.releaseYear and film.filmAge %}
                    <div style="display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); padding: 6px 14px; border-radius: 6px; font-size: 0.8em; margin-bottom: 12px; font-weight: 500; border: 1px solid rgba(255,255,255,0.1);">
                        <span style="opacity: 0.6;">üìÖ</span> Il y a {{ film.filmAge }} ans
                    </div>
                    {% endif %}
                    <div class="info-content">
                        <p class="realisateur">R√©alisateur : {{film.director}}</p>
                        <p class="casting">Casting : {{ film.casting }}</p>
                        <p class="genre">Genre : {{ film.genres }}</p>
                        <p class="duree">Dur√©e : {{film.duree}}</p>
                    </div>
                    <div class="synopsis_container">
                        <p class="synopsis">
                            {{film.synopsis}}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div style="height: 15px;"></div>
        
        <!-- Affichage en tableau de la semaine -->
    <div style="overflow-x: auto; margin-bottom: 20px;">
        <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: rgba(255,255,255,0.02); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06);">
            <thead>
                <tr style="background: rgba(255,255,255,0.04);">
                    <th style="padding: 16px; text-align: left; color: rgba(255,255,255,0.9); font-weight: 600; border-right: 1px solid rgba(255,255,255,0.06); font-size: 0.9em;">Cin√©ma</th>
                    {% for date in dates %}
                    <th style="padding: 14px 10px; text-align: center; color: rgba(255,255,255,0.9); font-size: 0.85em; border-right: 1px solid rgba(255,255,255,0.04);">
                        <div style="color: rgba(255,255,255,0.5); font-weight: 400; font-size: 0.85em;">{{date.jour}}</div>
                        <div style="font-size: 1.3em; font-weight: 700; margin: 4px 0;">{{date.chiffre}}</div>
                        <div style="font-size: 0.75em; color: rgba(255,255,255,0.5); font-weight: 400;">{{date.mois}}</div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for cinema_name, days_data in film.seances_table.items() %}
                <tr class="cinema-row" data-cinema="{{ cinema_name }}" style="border-top: 1px solid rgba(255,255,255,0.04);">
                    <td style="padding: 14px 16px; color: rgba(255,255,255,0.85); font-weight: 500; border-right: 1px solid rgba(255,255,255,0.06); white-space: nowrap; font-size: 0.9em;">
                        {{cinema_name}}
                    </td>
                    {% for date in dates %}
                    <td style="padding: 10px; text-align: center; border-right: 1px solid rgba(255,255,255,0.04);">
                        {% if date.index in days_data %}
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;">
                            {% for time in days_data[date.index] %}
                            <span style="background: rgba(255,255,255,0.12); color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.8em; white-space: nowrap; font-weight: 500; border: 1px solid rgba(255,255,255,0.15);">{{time}}</span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <span style="color: rgba(255,255,255,0.2); font-size: 0.9em;">‚Äî</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="responsive-div"></div>
    </div>
    {% endfor %}
    </div>

</div>

<script>
// Fonction de recherche de films en temps r√©el
function searchFilms() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase().trim();
    const filmItems = document.querySelectorAll('.film-item');
    const resultsText = document.getElementById('searchResults');
    
    // Sauvegarder la recherche dans localStorage
    localStorage.setItem('searchTerm', input.value);
    
    let visibleCount = 0;
    
    filmItems.forEach(filmItem => {
        // R√©cup√©rer tout le texte du film (titre, casting, r√©alisateur, genre, synopsis)
        const filmText = filmItem.textContent.toLowerCase();
        
        if (filter === '' || filmText.includes(filter)) {
            filmItem.style.display = '';
            visibleCount++;
        } else {
            filmItem.style.display = 'none';
        }
    });
    
    // Afficher le nombre de r√©sultats
    if (filter === '') {
        resultsText.textContent = '';
    } else {
        resultsText.textContent = `${visibleCount} film(s) trouv√©(s)`;
        resultsText.style.color = visibleCount > 0 ? '#4caf50' : '#f44336';
    }
}

// Fonction de filtre par cin√©ma
function filterByCinema() {
    const checkboxes = document.querySelectorAll('.cinema-checkbox-label input[type="checkbox"]');
    const selectedCinemas = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    // Sauvegarder les pr√©f√©rences dans localStorage
    localStorage.setItem('selectedCinemas', JSON.stringify(selectedCinemas));
    
    // Mettre √† jour les styles des labels
    checkboxes.forEach(checkbox => {
        const label = checkbox.closest('.cinema-checkbox-label');
        if (checkbox.checked) {
            label.classList.add('active');
        } else {
            label.classList.remove('active');
        }
    });
    
    // Filtrer les lignes des tableaux de s√©ances
    document.querySelectorAll('.cinema-row').forEach(row => {
        const cinemaName = row.dataset.cinema;
        if (selectedCinemas.includes(cinemaName)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Masquer les films qui n'ont plus de s√©ances visibles
    document.querySelectorAll('.film-item').forEach(filmItem => {
        const visibleRows = filmItem.querySelectorAll('.cinema-row:not([style*="display: none"])');
        
        // Si aucune ligne de cin√©ma n'est visible, masquer le film entier
        if (visibleRows.length === 0) {
            filmItem.style.display = 'none';
        } else {
            filmItem.style.display = '';
        }
    });
}

// Restaurer les pr√©f√©rences de cin√©ma au chargement
function restoreCinemaPreferences() {
    const savedCinemas = localStorage.getItem('selectedCinemas');
    
    if (savedCinemas) {
        try {
            const selectedCinemas = JSON.parse(savedCinemas);
            const checkboxes = document.querySelectorAll('.cinema-checkbox-label input[type="checkbox"]');
            
            // D√©cocher toutes les checkboxes
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Cocher seulement celles qui √©taient sauvegard√©es
            checkboxes.forEach(checkbox => {
                if (selectedCinemas.includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
            
            // Appliquer le filtre
            filterByCinema();
        } catch (e) {
            console.error('Erreur lors de la restauration des pr√©f√©rences:', e);
        }
    }
}

// Variable pour m√©moriser le tri actuel
let currentSort = 'popularity';

// Fonction de tri des films
function sortFilms(sortType) {
    const container = document.getElementById('filmsContainer');
    const films = Array.from(container.querySelectorAll('.film-item'));
    
    // Sauvegarder le tri dans localStorage
    localStorage.setItem('sortType', sortType);
    
    // Mettre √† jour l'apparence des boutons avec le nouveau style
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`sort-${sortType}`).classList.add('active');
    
    currentSort = sortType;
    
    // Trier les films selon le type
    films.sort((a, b) => {
        switch(sortType) {
            case 'popularity':
                // Popularit√© d√©croissante (par d√©faut)
                return parseInt(b.dataset.popularity) - parseInt(a.dataset.popularity);
            
            case 'alphabetical':
                // Ordre alphab√©tique A‚ÜíZ
                return a.dataset.title.localeCompare(b.dataset.title);
            
            case 'year-desc':
                // Ann√©e d√©croissante (plus r√©cent d'abord)
                return parseInt(b.dataset.year) - parseInt(a.dataset.year);
            
            case 'year-asc':
                // Ann√©e croissante (plus ancien d'abord)
                return parseInt(a.dataset.year) - parseInt(b.dataset.year);
            
            case 'showtimes':
                // Nombre de s√©ances d√©croissant
                return parseInt(b.dataset.showtimes) - parseInt(a.dataset.showtimes);
            
            default:
                return 0;
        }
    });
    
    // R√©organiser le DOM
    films.forEach(film => container.appendChild(film));
    
    // Animation subtile
    container.style.opacity = '0.7';
    setTimeout(() => {
        container.style.opacity = '1';
    }, 150);
}

// Variable globale pour suivre la semaine actuelle
let currentWeekOffset = {{ week_offset }};
let currentMinAge = {{ min_age }};
let isLoading = false;

// Fonction pour changer le filtre d'√¢ge dynamiquement
async function changeAgeFilter(minAge) {
    if (isLoading) return;
    
    isLoading = true;
    currentMinAge = minAge;
    
    // Sauvegarder le filtre d'√¢ge dans localStorage
    localStorage.setItem('minAge', minAge);
    
    try {
        // Afficher un indicateur de chargement
        const container = document.getElementById('filmsContainer');
        container.style.opacity = '0.5';
        
        // Mettre √† jour l'apparence des boutons
        document.querySelectorAll('.age-filter').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // R√©cup√©rer les donn√©es via l'API
        const response = await fetch(`/api/films?week=${currentWeekOffset}&age=${currentMinAge}`);
        const data = await response.json();
        
        // Mettre √† jour l'URL sans recharger la page
        const newUrl = currentMinAge > 0 ? `/?week=${currentWeekOffset}&age=${currentMinAge}` : `/?week=${currentWeekOffset}`;
        window.history.pushState({week: currentWeekOffset, age: currentMinAge}, '', newUrl);
        
        // Reconstruire le contenu HTML des films
        renderFilms(data.films, data.dates);
        
        // Restaurer l'opacit√©
        container.style.opacity = '1';
        
        // R√©appliquer les filtres et tri sauvegard√©s
        restoreCinemaPreferences();
        
        const savedSearch = localStorage.getItem('searchTerm');
        if (savedSearch) {
            document.getElementById('searchInput').value = savedSearch;
            searchFilms();
        }
        
        const savedSort = localStorage.getItem('sortType');
        if (savedSort) {
            sortFilms(savedSort);
        } else {
            sortFilms('popularity');
        }
        
    } catch (error) {
        console.error('Erreur lors du changement de filtre:', error);
        alert('Erreur lors du chargement des donn√©es');
        container.style.opacity = '1';
    } finally {
        isLoading = false;
    }
}

// Fonction pour changer de semaine dynamiquement
async function changeWeek(offset) {
    if (isLoading) return;
    
    isLoading = true;
    currentWeekOffset += offset;
    
    try {
        // Afficher un indicateur de chargement
        const container = document.getElementById('filmsContainer');
        container.style.opacity = '0.5';
        
        // R√©cup√©rer les donn√©es via l'API
        const response = await fetch(`/api/films?week=${currentWeekOffset}&age=${currentMinAge}`);
        const data = await response.json();
        
        // Mettre √† jour la p√©riode affich√©e
        document.getElementById('weekPeriod').textContent = `üìÖ ${data.week_period}`;
        
        // Mettre √† jour l'URL sans recharger la page
        const newUrl = `/?week=${currentWeekOffset}&age=${currentMinAge}`;
        window.history.pushState({week: currentWeekOffset}, '', newUrl);
        
        // Reconstruire le contenu HTML des films
        renderFilms(data.films, data.dates);
        
        // Restaurer l'opacit√©
        container.style.opacity = '1';
        
        // R√©appliquer les filtres et tri sauvegard√©s
        restoreCinemaPreferences();
        
        const savedSearch = localStorage.getItem('searchTerm');
        if (savedSearch) {
            document.getElementById('searchInput').value = savedSearch;
            searchFilms();
        }
        
        const savedSort = localStorage.getItem('sortType');
        if (savedSort) {
            sortFilms(savedSort);
        } else {
            // Tri par popularit√© par d√©faut
            sortFilms('popularity');
        }
        
    } catch (error) {
        console.error('Erreur lors du changement de semaine:', error);
        alert('Erreur lors du chargement des donn√©es');
        container.style.opacity = '1';
    } finally {
        isLoading = false;
    }
}

// Fonction pour g√©n√©rer le HTML d'un film
function renderFilms(films, dates) {
    const container = document.getElementById('filmsContainer');
    
    if (films.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">Aucun film trouv√© pour cette semaine</div>';
        return;
    }
    
    container.innerHTML = films.map(film => {
        // Construire les en-t√™tes de dates
        const datesHeader = dates.map(date => `
            <th style="padding: 14px 10px; text-align: center; color: rgba(255,255,255,0.9); font-size: 0.85em; border-right: 1px solid rgba(255,255,255,0.04);">
                <div style="color: rgba(255,255,255,0.5); font-weight: 400; font-size: 0.85em;">${date.jour}</div>
                <div style="font-size: 1.3em; font-weight: 700; margin: 4px 0;">${date.chiffre}</div>
                <div style="font-size: 0.75em; color: rgba(255,255,255,0.5); font-weight: 400;">${date.mois}</div>
            </th>
        `).join('');
        
        // Construire le tableau des s√©ances
        let seancesHTML = '';
        for (const [cinema, days] of Object.entries(film.seances_table || {})) {
            seancesHTML += `
                <tr class="cinema-row" data-cinema="${cinema}" style="border-top: 1px solid rgba(255,255,255,0.04);">
                    <td style="padding: 14px 16px; color: rgba(255,255,255,0.85); font-weight: 500; border-right: 1px solid rgba(255,255,255,0.06); white-space: nowrap; font-size: 0.9em;">
                        ${cinema}
                    </td>`;
            
            for (let i = 0; i < 7; i++) {
                const times = days[i] || [];
                if (times.length > 0) {
                    seancesHTML += `
                        <td style="padding: 10px; text-align: center; border-right: 1px solid rgba(255,255,255,0.04);">
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;">
                                ${times.map(time => `<span style="background: rgba(255,255,255,0.12); color: white; padding: 5px 10px; border-radius: 6px; font-size: 0.8em; white-space: nowrap; font-weight: 500; border: 1px solid rgba(255,255,255,0.15);">${time}</span>`).join('')}
                            </div>
                        </td>`;
                } else {
                    seancesHTML += `<td style="padding: 10px; text-align: center; border-right: 1px solid rgba(255,255,255,0.04);"><span style="color: rgba(255,255,255,0.2); font-size: 0.9em;">‚Äî</span></td>`;
                }
            }
            seancesHTML += '</tr>';
        }
        
        const filmAge = film.filmAge || '';
        const releaseYear = film.releaseYear || '';
        
        return `
            <div class="film-item" 
                 data-title="${film.title || ''}" 
                 data-year="${releaseYear}"
                 data-popularity="${film.wantToSee || 0}"
                 data-showtimes="${film.total_showtimes || 0}">
                
                <div class="container_infoFilm">
                    <img src="${film.affiche || ''}" class="affiche" />
                    <div class="infoFilm">
                        <div class="blur-background"></div>
                        <div>
                            <h3 class="titreFilm">
                                <a href="${film.url || '#'}">${film.title || ''}</a>
                                ${releaseYear ? `<span style="font-size: 0.75em; color: rgba(255,255,255,0.4); font-weight: 400; margin-left: 8px;">(${releaseYear})</span>` : ''}
                            </h3>
                            ${releaseYear && filmAge ? `
                            <div style="display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7); padding: 6px 14px; border-radius: 6px; font-size: 0.8em; margin-bottom: 12px; font-weight: 500; border: 1px solid rgba(255,255,255,0.1);">
                                <span style="opacity: 0.6;">üìÖ</span> Il y a ${filmAge} ans
                            </div>
                            ` : ''}
                            <div class="info-content">
                                <p class="realisateur">R√©alisateur : ${film.director || 'N/A'}</p>
                                <p class="casting">Casting : ${film.casting || 'N/A'}</p>
                                <p class="genre">Genre : ${film.genres || 'N/A'}</p>
                                <p class="duree">Dur√©e : ${film.duree || 'N/A'}</p>
                            </div>
                            <div class="synopsis_container">
                                <p class="synopsis">
                                    ${film.synopsis || ''}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="height: 15px;"></div>
                
                <div style="overflow-x: auto; margin-bottom: 20px;">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: rgba(255,255,255,0.02); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06);">
                        <thead>
                            <tr style="background: rgba(255,255,255,0.04);">
                                <th style="padding: 16px; text-align: left; color: rgba(255,255,255,0.9); font-weight: 600; border-right: 1px solid rgba(255,255,255,0.06); font-size: 0.9em;">Cin√©ma</th>
                                ${datesHeader}
                            </tr>
                        </thead>
                        <tbody>
                            ${seancesHTML}
                        </tbody>
                    </table>
                </div>
                
                <div class="responsive-div"></div>
            </div>
        `;
    }).join('');
}

// G√©rer le bouton retour du navigateur
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.week !== undefined) {
        const offset = event.state.week - currentWeekOffset;
        changeWeek(offset);
    }
});

// Restaurer les pr√©f√©rences au chargement de la page
window.addEventListener('load', () => {
    // Restaurer le filtre d'√¢ge
    const savedMinAge = localStorage.getItem('minAge');
    if (savedMinAge !== null) {
        const minAge = parseInt(savedMinAge);
        if (minAge !== currentMinAge) {
            // Si le filtre sauvegard√© est diff√©rent de celui de l'URL, utiliser celui sauvegard√©
            currentMinAge = minAge;
            // Mettre √† jour l'apparence des boutons
            document.querySelectorAll('.age-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`.age-filter[onclick="changeAgeFilter(${minAge})"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
    }
    
    // Restaurer les pr√©f√©rences de cin√©ma
    restoreCinemaPreferences();
    
    // Restaurer la recherche
    const searchInput = document.getElementById('searchInput');
    const savedSearch = localStorage.getItem('searchTerm');
    if (searchInput && savedSearch) {
        searchInput.value = savedSearch;
        searchFilms();
    }
    
    // Restaurer le tri
    const savedSort = localStorage.getItem('sortType');
    if (savedSort) {
        sortFilms(savedSort);
    }
});
</script>

{% endblock %}
