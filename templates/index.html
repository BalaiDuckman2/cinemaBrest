{% extends 'base.html' %}

{% block head %}
<!-- Google Fonts: Bebas Neue, Playfair Display, Crimson Text -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Bebas+Neue&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

<style>
    /* === FONTS === */
    .font-bebas { font-family: 'Bebas Neue', sans-serif; }
    .font-playfair { font-family: 'Playfair Display', serif; }
    .font-crimson { font-family: 'Crimson Text', serif; }

    /* === CUSTOM COLORS === */
    .bg-rouge-cinema { background-color: #D32F2F; }
    .bg-jaune-marquise { background-color: #F9A825; }
    .bg-creme-ecran { background-color: #FFF8E1; }
    .bg-sepia-chaud { background-color: #8D6E63; }
    .bg-noir-velours { background-color: #1A1A1A; }
    .bg-or-antique { background-color: #FFD54F; }
    .bg-bordeaux-profond { background-color: #B71C1C; }
    .bg-beige-papier { background-color: #EFEBE9; }

    .text-rouge-cinema { color: #D32F2F; }
    .text-jaune-marquise { color: #F9A825; }
    .text-creme-ecran { color: #FFF8E1; }
    .text-sepia-chaud { color: #8D6E63; }
    .text-noir-velours { color: #1A1A1A; }
    .text-or-antique { color: #FFD54F; }
    .text-bordeaux-profond { color: #B71C1C; }

    .border-rouge-cinema { border-color: #D32F2F; }
    .border-sepia-chaud { border-color: #8D6E63; }
    .border-or-antique { border-color: #FFD54F; }

    .accent-rouge-cinema { accent-color: #D32F2F; }

    /* === FILM STRIP BORDER === */
    .film-strip-border {
        position: relative;
        padding-top: 24px;
        padding-bottom: 24px;
    }

    .film-strip-border::before,
    .film-strip-border::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        height: 20px;
        background:
            repeating-linear-gradient(
                90deg,
                #1A1A1A 0px,
                #1A1A1A 15px,
                transparent 15px,
                transparent 20px
            ),
            linear-gradient(180deg, #1A1A1A 0px, #1A1A1A 4px, transparent 4px, transparent 8px, #1A1A1A 8px, #1A1A1A 12px, transparent 12px, transparent 16px, #1A1A1A 16px, #1A1A1A 20px);
        background-size: 20px 100%, 100% 20px;
    }

    .film-strip-border::before {
        top: 0;
    }

    .film-strip-border::after {
        bottom: 0;
        border-top: 2px solid #F9A825;
    }

    /* === VINTAGE TEXTURE OVERLAY === */
    .vintage-texture {
        position: relative;
    }

    .vintage-texture::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        pointer-events: none;
        mix-blend-mode: overlay;
        border-radius: inherit;
    }

    /* === SPOTLIGHT GLOW EFFECT (Desktop only) === */
    @media (min-width: 768px) {
        .spotlight-glow {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .spotlight-glow::after {
            content: '';
            position: absolute;
            inset: -10px;
            background: radial-gradient(circle at 50% 0%, rgba(249, 168, 37, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            border-radius: inherit;
        }

        .spotlight-glow:hover::after {
            opacity: 1;
        }

        .spotlight-glow:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
    }

    /* === STAGE CURTAIN HEADER === */
    .stage-curtain {
        background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
        position: relative;
        overflow: hidden;
    }

    .stage-curtain::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 200%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent 0%,
            rgba(255, 255, 255, 0.1) 45%,
            rgba(255, 255, 255, 0.2) 50%,
            rgba(255, 255, 255, 0.1) 55%,
            transparent 100%
        );
        animation: curtain-shimmer 8s ease-in-out infinite;
    }

    @keyframes curtain-shimmer {
        0%, 100% { transform: translateX(0); }
        50% { transform: translateX(50%); }
    }

    /* === TICKET CARD DESIGN === */
    .ticket-card {
        background: #FFF8E1;
        border: 2px solid #8D6E63;
        border-radius: 8px;
        position: relative;
        box-shadow:
            0 4px 6px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.8);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ticket-card::before {
        content: '';
        position: absolute;
        top: -2px;
        right: -2px;
        width: 20px;
        height: 20px;
        background: #EFEBE9;
        border-bottom-left-radius: 20px;
        border: 2px solid #8D6E63;
        border-top: none;
        border-right: none;
    }

    /* === TICKET CHIP (Cinema filters) === */
    .ticket-chip {
        transition: all 0.2s ease;
    }

    .ticket-chip:hover {
        border-color: #D32F2F;
        box-shadow: 0 2px 4px rgba(211, 47, 47, 0.2);
        transform: translateY(-1px);
    }

    /* === BODY BACKGROUND === */
    body {
        background: linear-gradient(to bottom right, #EFEBE9 0%, #FFF8E1 50%, #EFEBE9 100%);
    }
</style>
{% endblock %}

{% block body %}

<!-- Bouton retour en haut -->
<button id="scrollTopBtn" onclick="scrollToTop()"
    class="fixed bottom-4 right-4 md:bottom-8 md:right-8 bg-rouge-cinema hover:bg-bordeaux-profond text-creme-ecran p-3 md:p-4 rounded-full shadow-lg transition-all duration-300 hover:scale-110 z-50 opacity-0 pointer-events-none border-2 border-or-antique">
    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
</button>

<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8 max-w-7xl">

    <!-- Navigation entre semaines -->
    <div class="bg-beige-papier border-2 border-sepia-chaud rounded-xl md:rounded-2xl p-3 sm:p-5 mb-4 sm:mb-6 shadow-md">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4">
            <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto justify-between sm:justify-center">
                <button onclick="changeWeek(-1)" style="font-family: 'Bebas Neue', sans-serif;"
                    class="px-3 sm:px-6 py-2 sm:py-2.5 bg-creme-ecran hover:bg-or-antique/20 border-2 border-sepia-chaud hover:border-rouge-cinema rounded-lg sm:rounded-xl text-noir-velours text-sm sm:text-base uppercase tracking-wide transition-all duration-200 hover:-translate-x-1">
                    <span class="hidden sm:inline">← Précédent</span>
                    <span class="sm:hidden">←</span>
                </button>
                <div id="weekPeriod" style="font-family: 'Crimson Text', serif;"
                    class="px-3 sm:px-8 py-2 sm:py-2.5 bg-rouge-cinema border-2 border-bordeaux-profond rounded-lg sm:rounded-xl text-creme-ecran text-xs sm:text-base font-semibold text-center flex-1 sm:flex-none shadow-md">
                    <span class="hidden sm:inline">📅 </span>{{ week_period }}
                </div>
                <button onclick="changeWeek(1)" style="font-family: 'Bebas Neue', sans-serif;"
                    class="px-3 sm:px-6 py-2 sm:py-2.5 bg-creme-ecran hover:bg-or-antique/20 border-2 border-sepia-chaud hover:border-rouge-cinema rounded-lg sm:rounded-xl text-noir-velours text-sm sm:text-base uppercase tracking-wide transition-all duration-200 hover:translate-x-1">
                    <span class="hidden sm:inline">Suivant →</span>
                    <span class="sm:hidden">→</span>
                </button>
            </div>
            <button id="todayBtn" onclick="goToToday()" style="font-family: 'Bebas Neue', sans-serif;"
                class="hidden px-3 sm:px-4 py-2 sm:py-2.5 bg-jaune-marquise hover:bg-or-antique border-2 border-or-antique rounded-lg sm:rounded-xl text-noir-velours text-sm sm:text-base font-bold uppercase tracking-wide transition-all duration-200 hover:scale-105 shadow-lg">
                <span class="hidden sm:inline">🎬 Aujourd'hui</span>
                <span class="sm:hidden">Aujourd'hui</span>
            </button>
        </div>
    </div>

    <!-- Barre de recherche et filtres compacts (universelle) -->
    <div class="mb-4">
        <!-- Recherche toujours visible sur mobile -->
        <div class="flex gap-2">
            <div class="flex-1 relative">
                <input type="text" id="searchInput" oninput="searchFilms()" placeholder="Rechercher un film..." style="font-family: 'Crimson Text', serif;"
                    class="w-full px-3 py-2 bg-creme-ecran border-2 border-sepia-chaud rounded-lg text-noir-velours text-sm placeholder-sepia-chaud/60 focus:outline-none focus:ring-2 focus:ring-rouge-cinema focus:border-rouge-cinema shadow-sm">
                <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-sepia-chaud" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
            <button onclick="toggleMobileFilters()" id="mobileFilterBtn" style="font-family: 'Bebas Neue', sans-serif;"
                class="px-3 py-2 bg-beige-papier border-2 border-sepia-chaud rounded-lg text-noir-velours text-sm uppercase tracking-wide transition hover:bg-creme-ecran hover:border-rouge-cinema flex items-center gap-1.5 shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                <span id="filterBadge"
                    class="hidden bg-rouge-cinema text-creme-ecran text-[10px] font-bebas px-1.5 py-0.5 rounded-full">0</span>
            </button>
        </div>
        <p id="searchResults" style="font-family: 'Crimson Text', serif;" class="text-xs text-sepia-chaud mt-1.5 italic"></p>
    </div>

    <!-- Filtres collapsibles (universels) -->
    <div id="filtersPanel"
        class="hidden bg-beige-papier border-2 border-sepia-chaud rounded-xl p-3 sm:p-4 mb-4 space-y-3 shadow-md">
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3">
            <select id="sortSelect" onchange="sortFilms(this.value)" style="font-family: 'Crimson Text', serif;"
                class="px-2 py-2 bg-creme-ecran border-2 border-sepia-chaud rounded-lg text-noir-velours text-xs focus:outline-none focus:border-rouge-cinema focus:ring-2 focus:ring-rouge-cinema/20">
                <option value="popularity">Popularité</option>
                <option value="alphabetical">A→Z</option>
                <option value="year-desc">+ Récent</option>
                <option value="year-asc">+ Ancien</option>
                <option value="showtimes">Nb séances</option>
            </select>
            <select id="versionSelect" onchange="filterByVersion(this.value)" style="font-family: 'Crimson Text', serif;"
                class="px-2 py-2 bg-creme-ecran border-2 border-sepia-chaud rounded-lg text-noir-velours text-xs focus:outline-none focus:border-rouge-cinema focus:ring-2 focus:ring-rouge-cinema/20">
                <option value="all">Toutes versions</option>
                <option value="VF">VF</option>
                <option value="VO">VO/VOST</option>
            </select>
            <select id="daySelect" onchange="filterByDay(this.value)" style="font-family: 'Crimson Text', serif;"
                class="px-2 py-2 bg-creme-ecran border-2 border-sepia-chaud rounded-lg text-noir-velours text-xs focus:outline-none focus:border-rouge-cinema focus:ring-2 focus:ring-rouge-cinema/20">
                <option value="all">Tous les jours</option>
                <option value="weekday">Semaine (Lun-Jeu)</option>
                <option value="weekend">Weekend (Ven-Dim)</option>
                <option value="0">Lundi</option>
                <option value="1">Mardi</option>
                <option value="2">Mercredi</option>
                <option value="3">Jeudi</option>
                <option value="4">Vendredi</option>
                <option value="5">Samedi</option>
                <option value="6">Dimanche</option>
            </select>
            <select id="timeSlotSelect" onchange="filterByTimeSlot(this.value)" style="font-family: 'Crimson Text', serif;"
                class="px-2 py-2 bg-creme-ecran border-2 border-sepia-chaud rounded-lg text-noir-velours text-xs focus:outline-none focus:border-rouge-cinema focus:ring-2 focus:ring-rouge-cinema/20">
                <option value="all">Tous horaires</option>
                <option value="morning">Matin</option>
                <option value="afternoon">Après-midi</option>
                <option value="evening">Soirée</option>
                <option value="night">Nuit</option>
            </select>
        </div>
        <!-- Cinémas en chips -->
        <div class="flex flex-wrap gap-1.5">
            <label style="font-family: 'Bebas Neue', sans-serif;"
                class="ticket-chip flex items-center gap-1.5 px-3 py-1.5 bg-creme-ecran border-2 border-sepia-chaud rounded-full text-[11px] text-noir-velours uppercase tracking-wide cursor-pointer">
                <input type="checkbox" value="Les Studios" checked onchange="filterByCinema()"
                    class="w-3.5 h-3.5 rounded accent-rouge-cinema">
                Studios
            </label>
            <label style="font-family: 'Bebas Neue', sans-serif;"
                class="ticket-chip flex items-center gap-1.5 px-3 py-1.5 bg-creme-ecran border-2 border-sepia-chaud rounded-full text-[11px] text-noir-velours uppercase tracking-wide cursor-pointer">
                <input type="checkbox" value="CGR Brest Le Celtic" checked onchange="filterByCinema()"
                    class="w-3.5 h-3.5 rounded accent-rouge-cinema">
                CGR
            </label>
            <label style="font-family: 'Bebas Neue', sans-serif;"
                class="ticket-chip flex items-center gap-1.5 px-3 py-1.5 bg-creme-ecran border-2 border-sepia-chaud rounded-full text-[11px] text-noir-velours uppercase tracking-wide cursor-pointer">
                <input type="checkbox" value="Multiplexe Liberté" checked onchange="filterByCinema()"
                    class="w-3.5 h-3.5 rounded accent-rouge-cinema">
                Liberté
            </label>
            <label style="font-family: 'Bebas Neue', sans-serif;"
                class="ticket-chip flex items-center gap-1.5 px-3 py-1.5 bg-creme-ecran border-2 border-sepia-chaud rounded-full text-[11px] text-noir-velours uppercase tracking-wide cursor-pointer">
                <input type="checkbox" value="Pathé Capucins" checked onchange="filterByCinema()"
                    class="w-3.5 h-3.5 rounded accent-rouge-cinema">
                Pathé
            </label>
            <label style="font-family: 'Bebas Neue', sans-serif;"
                class="ticket-chip flex items-center gap-1.5 px-3 py-1.5 bg-creme-ecran border-2 border-sepia-chaud rounded-full text-[11px] text-noir-velours uppercase tracking-wide cursor-pointer">
                <input type="checkbox" value="Ciné Galaxy" checked onchange="filterByCinema()"
                    class="w-3.5 h-3.5 rounded accent-rouge-cinema">
                Galaxy
            </label>
            <label style="font-family: 'Bebas Neue', sans-serif;"
                class="ticket-chip flex items-center gap-1.5 px-3 py-1.5 bg-creme-ecran border-2 border-sepia-chaud rounded-full text-[11px] text-noir-velours uppercase tracking-wide cursor-pointer">
                <input type="checkbox" value="Les Baladins" checked onchange="filterByCinema()"
                    class="w-3.5 h-3.5 rounded accent-rouge-cinema">
                Baladins
            </label>
        </div>
    </div>


    <!-- Vue Grille Responsive (universelle) -->
    <div id="filmsContainer">
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4">
            {% for film in films %}
            <div class="ticket-card vintage-texture spotlight-glow cursor-pointer overflow-hidden" onclick="openFilmDrawer({{ loop.index0 }})"
                data-title="{{ film.title }}" data-year="{{ film.releaseYear or 0 }}"
                data-popularity="{{ film.wantToSee or 0 }}" data-showtimes="{{ film.total_showtimes or 0 }}"
                data-index="{{ loop.index0 }}">
                <div class="relative">
                    <img src="{{ film.affiche }}" alt="{{ film.title }}"
                        class="w-full h-56 sm:h-64 md:h-72 lg:h-80 object-cover">

                    <!-- Overlay gradient chaud -->
                    <div class="absolute inset-0 bg-gradient-to-t from-noir-velours via-transparent to-transparent opacity-60"></div>

                    <!-- Titre sur overlay -->
                    <div class="absolute bottom-0 left-0 right-0 p-3">
                        <h2 style="font-family: 'Playfair Display', serif;" class="text-base sm:text-lg font-bold text-creme-ecran drop-shadow-lg line-clamp-2">{{ film.title }}</h2>
                        {% if film.releaseYear %}
                        <p style="font-family: 'Crimson Text', serif;" class="text-xs text-or-antique mt-0.5 italic">{{ film.releaseYear }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Perforations de ticket -->
                <div class="h-2 bg-gradient-to-r from-transparent via-sepia-chaud to-transparent opacity-30"></div>
            </div>
            {% endfor %}
        </div>

        <!-- Message si aucun film après filtrage -->
        <div id="noResults" style="font-family: 'Crimson Text', serif;" class="hidden text-center py-12 px-4">
            <p class="text-2xl text-sepia-chaud mb-2">🎬</p>
            <p class="text-lg text-noir-velours font-semibold mb-1">Aucun film trouvé</p>
            <p class="text-sm text-sepia-chaud italic">Essayez de modifier vos filtres</p>
        </div>
    </div>

    <!-- Bottom Sheet / Drawer (universel) -->
    <div id="filmDrawer"
        class="fixed inset-x-0 bottom-0 max-w-4xl mx-auto transform translate-y-full transition-transform duration-300 ease-out z-50">
        <!-- Curved top edge (écran de cinéma) -->
        <div class="absolute -top-6 left-1/2 -translate-x-1/2 w-32 h-6 bg-creme-ecran rounded-t-full border-t-2 border-x-2 border-sepia-chaud"></div>

        <div class="bg-creme-ecran rounded-t-3xl max-h-[85vh] overflow-hidden shadow-2xl border-t-4 border-rouge-cinema">
            <!-- Handle bar et bouton fermer -->
            <div class="sticky top-0 bg-creme-ecran pt-3 pb-2 z-10 flex items-center justify-between px-4 border-b border-sepia-chaud/20">
                <div class="w-8"></div>
                <!-- Grip handle vintage (or antique) -->
                <div class="w-16 h-1.5 bg-or-antique rounded-full cursor-pointer shadow-inner" onclick="closeFilmDrawer()"></div>
                <button onclick="closeFilmDrawer()"
                    class="w-8 h-8 flex items-center justify-center text-sepia-chaud hover:text-rouge-cinema transition rounded-full hover:bg-beige-papier">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Contenu du drawer -->
            <div id="drawerContent" class="px-4 sm:px-6 pb-8 overflow-y-auto max-h-[calc(85vh-50px)]">
                <!-- Rempli dynamiquement par JS -->
            </div>
        </div>
    </div>

    <!-- Backdrop pour le drawer -->
    <div id="drawerBackdrop" class="fixed inset-0 bg-noir-velours/70 z-40 hidden" onclick="closeFilmDrawer()"></div>

</div>

<style>
    /* Styles pour les select dropdowns */
    select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
    }

    select option {
        background-color: #1f2937;
        color: white;
    }

    /* Masquer la scrollbar sur le carousel mobile */
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    /* Animation du drawer */
    #filmDrawer {
        will-change: transform;
    }

    /* Drawer ouvert */
    #filmDrawer.drawer-open {
        transform: translateY(0) !important;
    }

    /* Empêcher le scroll du body quand le drawer est ouvert */
    body.drawer-active {
        overflow: hidden;
    }

    /* Effet hover pour les cartes de films sur desktop */
    @media (min-width: 768px) {
        .film-mobile-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .film-mobile-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
    }
</style>

<script>
    // Données des films pour le drawer mobile
    const filmsData = {{ films| tojson | safe }};
    const datesData = {{ dates| tojson | safe }};

    // État du drawer
    let currentDrawerFilmIndex = null;
    let drawerTouchStartY = 0;
    let drawerTouchCurrentY = 0;

    // Ouvrir le drawer avec les informations du film
    function openFilmDrawer(filmIndex) {
        const film = filmsData[filmIndex];
        if (!film) return;

        currentDrawerFilmIndex = filmIndex;

        // Construire le HTML du drawer
        const drawerContent = document.getElementById('drawerContent');

        // En-tête avec affiche et titre
        let html = `
        <div class="flex gap-4 mb-6">
            <img src="${film.affiche || ''}" alt="${film.title}" class="w-24 h-36 object-cover rounded-lg shadow-lg flex-shrink-0 border-2 border-sepia-chaud">
            <div class="flex-1 min-w-0">
                <h3 style="font-family: 'Playfair Display', serif;" class="text-2xl font-bold text-noir-velours leading-tight">${film.title}</h3>
                <p style="font-family: 'Crimson Text', serif;" class="text-sepia-chaud text-sm mt-1 italic">${film.releaseYear ? film.releaseYear + ' · ' : ''}${film.duree || ''}</p>
                ${film.filmAge ? `<span style="font-family: 'Bebas Neue', sans-serif;" class="inline-block mt-2 bg-or-antique/20 text-sepia-chaud px-2 py-1 rounded text-xs uppercase tracking-wide border border-or-antique/40">Il y a ${film.filmAge} ans</span>` : ''}
                <a href="${film.url || '#'}" target="_blank" rel="noopener noreferrer" style="font-family: 'Crimson Text', serif;" class="inline-flex items-center gap-1 mt-2 text-rouge-cinema text-sm hover:text-bordeaux-profond underline">
                    Voir sur Letterboxd
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                </a>
            </div>
        </div>

        <!-- Art Deco Divider -->
        <div class="mb-6">
            <svg viewBox="0 0 200 20" class="w-full h-5">
                <line x1="0" y1="10" x2="80" y2="10" stroke="#F9A825" stroke-width="2"/>
                <circle cx="100" cy="10" r="6" fill="#D32F2F" stroke="#F9A825" stroke-width="2"/>
                <line x1="120" y1="10" x2="200" y2="10" stroke="#F9A825" stroke-width="2"/>
            </svg>
        </div>
    `;

        // Séances : Vue accordéon par jour (mobile-first)
        html += '<div class="mb-8">';
        html += '<h4 style="font-family: \'Bebas Neue\', sans-serif;" class="text-rouge-cinema text-2xl uppercase tracking-wider mb-4 flex items-center gap-2"><span>🎬</span> Programme de la Semaine</h4>';

        const seancesTable = film.seances_table || {};

        // Récupérer tous les filtres actifs
        const savedCinemas = localStorage.getItem('selectedCinemas');
        let selectedCinemas = ['Les Studios', 'CGR Brest Le Celtic', 'Multiplexe Liberté', 'Pathé Capucins', 'Ciné Galaxy', 'Les Baladins'];
        if (savedCinemas) {
            try {
                const parsedCinemas = JSON.parse(savedCinemas);
                if (parsedCinemas.length > 0) {
                    selectedCinemas = parsedCinemas;
                }
            } catch (e) { }
        }

        const versionFilter = localStorage.getItem('versionFilter') || 'all';
        const timeSlotFilter = localStorage.getItem('timeSlotFilter') || 'all';
        const dayFilter = localStorage.getItem('selectedDay') || 'all';

        // Filtrer les cinémas selon le filtre actif
        const cinemaNames = Object.keys(seancesTable).filter(cinema => selectedCinemas.includes(cinema));

        const cinemaShortNames = {
            'Les Studios': 'Studios',
            'CGR Brest Le Celtic': 'CGR',
            'Multiplexe Liberté': 'Liberté',
            'Pathé Capucins': 'Pathé',
            'Ciné Galaxy': 'Galaxy',
            'Les Baladins': 'Baladins'
        };

        if (cinemaNames.length === 0) {
            html += '<p style="font-family: \'Crimson Text\', serif;" class="text-sepia-chaud text-sm italic">Aucune séance disponible pour les cinémas sélectionnés</p>';
        } else {
            // Vue par jour (accordéon verticale)
            html += '<div class="space-y-2">';

            datesData.forEach((dateInfo, dayIndex) => {
                // Vérifier si ce jour correspond au filtre de jour
                if (!isDayInFilter(dayIndex, dayFilter)) return;

                // Vérifier si ce jour a au moins une séance après filtrage
                let hasShowtimes = false;
                cinemaNames.forEach(cinemaName => {
                    const daysData = seancesTable[cinemaName] || {};
                    const showtimes = daysData[String(dayIndex)] || [];

                    // Vérifier s'il y a au moins une séance qui correspond aux filtres
                    const hasMatchingShowtime = showtimes.some(showtime => {
                        const time = typeof showtime === 'string' ? showtime : showtime.time;
                        const version = typeof showtime === 'object' && showtime.version ? showtime.version : '';

                        // Vérifier le filtre de version
                        if (versionFilter === 'VF' && version !== 'VF') return false;
                        if (versionFilter === 'VO' && !version.includes('VO') && !version.includes('VOST')) return false;

                        // Vérifier le filtre de créneau horaire
                        if (timeSlotFilter !== 'all' && !isInTimeSlot(time, timeSlotFilter)) return false;

                        return true;
                    });

                    if (hasMatchingShowtime) hasShowtimes = true;
                });

                if (!hasShowtimes) return; // Skip les jours sans séances correspondant aux filtres

                // Carte de jour
                html += `
                <details class="group bg-beige-papier rounded-lg border-2 border-sepia-chaud shadow-sm overflow-hidden" ${dayIndex === 0 ? 'open' : ''}>
                    <summary style="background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);" class="p-3 cursor-pointer flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div style="font-family: 'Playfair Display', serif;" class="text-creme-ecran flex flex-col items-center min-w-[50px]">
                                <span style="font-family: 'Bebas Neue', sans-serif;" class="text-xs uppercase tracking-wider opacity-90">${dateInfo.jour}</span>
                                <span class="text-3xl font-bold leading-none">${dateInfo.chiffre}</span>
                                <span class="text-xs italic opacity-80">${dateInfo.mois}</span>
                            </div>
                            <div style="font-family: 'Bebas Neue', sans-serif;" class="text-creme-ecran text-sm uppercase tracking-wide">
                                Séances du jour
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-jaune-marquise transform transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </summary>

                    <div class="p-4 space-y-4 bg-creme-ecran">
                `;

                // Pour chaque cinéma
                cinemaNames.forEach(cinemaName => {
                    const daysData = seancesTable[cinemaName] || {};
                    const showtimes = daysData[String(dayIndex)] || [];

                    // Filtrer les séances selon les filtres actifs
                    const filteredShowtimes = showtimes.filter(showtime => {
                        const time = typeof showtime === 'string' ? showtime : showtime.time;
                        const version = typeof showtime === 'object' && showtime.version ? showtime.version : '';

                        // Vérifier le filtre de version
                        if (versionFilter === 'VF' && version !== 'VF') return false;
                        if (versionFilter === 'VO' && !version.includes('VO') && !version.includes('VOST')) return false;

                        // Vérifier le filtre de créneau horaire
                        if (timeSlotFilter !== 'all' && !isInTimeSlot(time, timeSlotFilter)) return false;

                        return true;
                    });

                    if (filteredShowtimes.length > 0) {
                        const shortName = cinemaShortNames[cinemaName] || cinemaName;

                        html += `
                        <div class="border-b border-sepia-chaud/30 last:border-0 pb-3 last:pb-0">
                            <h5 style="font-family: 'Bebas Neue', sans-serif;" class="text-rouge-cinema text-sm uppercase tracking-wider mb-2 flex items-center gap-2">
                                <span class="w-1 h-4 bg-rouge-cinema rounded-full"></span>
                                ${shortName}
                            </h5>
                            <div class="flex flex-wrap gap-2">
                        `;

                        filteredShowtimes.forEach(showtime => {
                            const time = typeof showtime === 'string' ? showtime : showtime.time;
                            const version = typeof showtime === 'object' && showtime.version ? showtime.version : '';

                            const filmTitleEscaped = JSON.stringify(film.title);
                            const cinemaEscaped = JSON.stringify(cinemaName);
                            const dateEscaped = JSON.stringify(dateInfo.date);
                            const timeEscaped = JSON.stringify(time);
                            const filmUrlEscaped = JSON.stringify(film.url || '');
                            const filmPosterEscaped = JSON.stringify(film.affiche || '');
                            const versionEscaped = JSON.stringify(version);

                            html += `
                            <button
                                onclick="handleShowtimeClick(${filmTitleEscaped}, ${cinemaEscaped}, ${dateEscaped}, ${timeEscaped}, ${filmUrlEscaped}, ${filmPosterEscaped}, ${versionEscaped})"
                                data-film="${film.title}"
                                data-cinema="${cinemaName}"
                                data-date="${dateInfo.date}"
                                data-time="${time}"
                                data-version="${version}"
                                style="font-family: 'Bebas Neue', sans-serif; position: relative; background: linear-gradient(135deg, #D32F2F 0%, #C62828 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.15);"
                                class="showtime-slot text-creme-ecran px-3 py-2 rounded-md text-xs uppercase tracking-wider border-2 border-or-antique hover:border-jaune-marquise transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5">
                                <span class="font-bold text-sm block leading-none">${time}</span>
                                ${version ? `<span class="text-[9px] opacity-90 block mt-0.5 leading-none">${version}</span>` : ''}
                                <div style="position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #FFF8E1; border-bottom-left-radius: 8px;"></div>
                            </button>`;
                        });

                        html += '</div></div>';
                    }
                });

                html += '</div></details>';
            });

            html += '</div>';
        }

        html += '</div>';

        // Infos secondaires
        html += `
        <div class="border-t-2 border-sepia-chaud/30 pt-6 space-y-3 text-sm">
            ${film.director ? `<p style="font-family: 'Crimson Text', serif;" class="text-noir-velours"><span class="font-bold text-rouge-cinema">Réalisateur:</span> ${film.director}</p>` : ''}
            ${film.genres ? `<p style="font-family: 'Crimson Text', serif;" class="text-noir-velours"><span class="font-bold text-rouge-cinema">Genre:</span> ${film.genres}</p>` : ''}
            ${film.casting ? `<p style="font-family: 'Crimson Text', serif;" class="text-noir-velours"><span class="font-bold text-rouge-cinema">Casting:</span> ${film.casting}</p>` : ''}
            ${film.synopsis ? `<p style="font-family: 'Crimson Text', serif;" class="text-sepia-chaud text-xs mt-4 leading-relaxed italic">${film.synopsis}</p>` : ''}
        </div>
    `;

        drawerContent.innerHTML = html;

        // Colorer les séances déjà dans le calendrier
        colorizeShowtimes();

        // Ouvrir le drawer
        const drawer = document.getElementById('filmDrawer');
        const backdrop = document.getElementById('drawerBackdrop');

        drawer.classList.add('drawer-open');
        backdrop.classList.remove('hidden');
        document.body.classList.add('drawer-active');

        // Setup swipe to close
        setupDrawerSwipe();
    }

    // Fermer le drawer
    function closeFilmDrawer() {
        const drawer = document.getElementById('filmDrawer');
        const backdrop = document.getElementById('drawerBackdrop');

        drawer.classList.remove('drawer-open');
        backdrop.classList.add('hidden');
        document.body.classList.remove('drawer-active');

        currentDrawerFilmIndex = null;
    }

    // Gérer le swipe pour fermer le drawer
    function setupDrawerSwipe() {
        const drawer = document.getElementById('filmDrawer');
        const drawerInner = drawer.querySelector('.bg-creme-ecran');

        drawerInner.addEventListener('touchstart', handleDrawerTouchStart, { passive: true });
        drawerInner.addEventListener('touchmove', handleDrawerTouchMove, { passive: false });
        drawerInner.addEventListener('touchend', handleDrawerTouchEnd, { passive: true });
    }

    function handleDrawerTouchStart(e) {
        drawerTouchStartY = e.touches[0].clientY;
        drawerTouchCurrentY = drawerTouchStartY;
    }

    function handleDrawerTouchMove(e) {
        const drawerContent = document.getElementById('drawerContent');
        // Ne pas permettre le swipe si on est en train de scroller dans le contenu
        if (drawerContent.scrollTop > 0) return;

        drawerTouchCurrentY = e.touches[0].clientY;
        const deltaY = drawerTouchCurrentY - drawerTouchStartY;

        // Seulement permettre le swipe vers le bas
        if (deltaY > 0) {
            e.preventDefault();
            const drawer = document.getElementById('filmDrawer');
            drawer.style.transform = `translateY(${deltaY}px)`;
        }
    }

    function handleDrawerTouchEnd(e) {
        const deltaY = drawerTouchCurrentY - drawerTouchStartY;
        const drawer = document.getElementById('filmDrawer');

        // Si on a swipé assez loin (>100px), fermer le drawer
        if (deltaY > 100) {
            closeFilmDrawer();
        }

        // Reset la position
        drawer.style.transform = '';
        drawerTouchStartY = 0;
        drawerTouchCurrentY = 0;
    }

    // Fermer le drawer avec la touche Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && currentDrawerFilmIndex !== null) {
            closeFilmDrawer();
        }
    });

    // Toggle panneau de filtres mobile
    let mobileFiltersOpen = false;

    function toggleMobileFilters() {
        const panel = document.getElementById('filtersPanel');
        const btn = document.getElementById('mobileFilterBtn');
        mobileFiltersOpen = !mobileFiltersOpen;

        if (mobileFiltersOpen) {
            panel.classList.remove('hidden');
            btn.classList.add('bg-rouge-cinema/20', 'border-rouge-cinema');
        } else {
            panel.classList.add('hidden');
            btn.classList.remove('bg-rouge-cinema/20', 'border-rouge-cinema');
        }
    }

    // Fonction pour remonter en haut avec défilement smooth
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    // Fonction pour mettre à jour le badge de compteur de filtres
    function updateFilterBadge() {
        const badge = document.getElementById('filterBadge');
        if (!badge) return;

        let count = 0;

        // Vérifier le filtre de version
        const versionSelect = document.getElementById('versionSelect');
        if (versionSelect && versionSelect.value !== 'all') count++;

        // Vérifier le filtre de créneau horaire
        const timeSlotSelect = document.getElementById('timeSlotSelect');
        if (timeSlotSelect && timeSlotSelect.value !== 'all') count++;

        // Vérifier le filtre de jour
        const daySelect = document.getElementById('daySelect');
        if (daySelect && daySelect.value !== 'all') count++;

        // Vérifier le filtre de cinéma
        const checkboxes = document.querySelectorAll('.ticket-chip input');
        const uncheckedCount = Array.from(checkboxes).filter(cb => !cb.checked).length;
        if (uncheckedCount > 0) count++;

        // Afficher ou cacher le badge
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    // Gérer l'affichage du bouton scroll to top
    const scrollTopBtn = document.getElementById('scrollTopBtn');

    window.addEventListener('scroll', function () {
        if (window.scrollY > 300) {
            scrollTopBtn.classList.remove('opacity-0', 'pointer-events-none');
            scrollTopBtn.classList.add('opacity-100');
        } else {
            scrollTopBtn.classList.add('opacity-0', 'pointer-events-none');
            scrollTopBtn.classList.remove('opacity-100');
        }
    });

    // Variable globale pour suivre la semaine actuelle
    let currentWeekOffset = {{ week_offset }};
    let currentMinAge = {{ min_age }};
    let isLoading = false;

    // Initialiser les préférences sauvegardées au chargement
    window.addEventListener('DOMContentLoaded', function () {
        // Restaurer le tri sauvegardé
        const savedSort = localStorage.getItem('sortBy');
        if (savedSort) {
            document.getElementById('sortSelect').value = savedSort;
            sortFilms(savedSort);
        }

        // Restaurer les cinémas sélectionnés
        const savedCinemas = localStorage.getItem('selectedCinemas');
        if (savedCinemas) {
            const cinemasList = JSON.parse(savedCinemas);
            document.querySelectorAll('.ticket-chip input').forEach(checkbox => {
                checkbox.checked = cinemasList.includes(checkbox.value);
            });
        } else {
            // Si rien dans localStorage, sauvegarder les cinémas cochés par défaut
            const checkboxes = document.querySelectorAll('.ticket-chip input[type="checkbox"]');
            const defaultCinemas = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            localStorage.setItem('selectedCinemas', JSON.stringify(defaultCinemas));
        }
        filterByCinema();

        // Restaurer le filtre de version
        const savedVersion = localStorage.getItem('versionFilter');
        if (savedVersion) {
            document.getElementById('versionSelect').value = savedVersion;
            filterByVersion(savedVersion);
        }

        // Restaurer le filtre d'horaire
        const savedTimeSlot = localStorage.getItem('timeSlotFilter');
        if (savedTimeSlot) {
            document.getElementById('timeSlotSelect').value = savedTimeSlot;
            filterByTimeSlot(savedTimeSlot);
        }

        // Restaurer le filtre de jour
        const savedDay = localStorage.getItem('selectedDay');
        if (savedDay) {
            document.getElementById('daySelect').value = savedDay;
            filterByDay(savedDay);
        }

        // Afficher le bouton "Aujourd'hui" si on n'est pas sur la semaine actuelle
        updateTodayButton();
    });

    // Fonction pour retourner à la semaine actuelle
    function goToToday() {
        if (currentWeekOffset !== 0) {
            changeWeek(-currentWeekOffset);
        }
    }

    // Mettre à jour l'affichage du bouton "Aujourd'hui"
    function updateTodayButton() {
        const todayBtn = document.getElementById('todayBtn');
        if (currentWeekOffset !== 0) {
            todayBtn.classList.remove('hidden');
        } else {
            todayBtn.classList.add('hidden');
        }
    }

    // Fonction pour changer le filtre d'âge dynamiquement
    async function changeAgeFilter(minAge) {
        if (isLoading) return;

        isLoading = true;
        currentMinAge = minAge;

        // Sauvegarder le filtre d'âge dans localStorage
        localStorage.setItem('minAge', minAge);

        try {
            const container = document.getElementById('filmsContainer');
            container.style.opacity = '0.5';

            // Récupérer les données via l'API
            const response = await fetch(`/api/films?week=${currentWeekOffset}&age=${currentMinAge}`);
            const data = await response.json();

            // Mettre à jour l'URL sans recharger la page
            const newUrl = currentMinAge > 0 ? `/?week=${currentWeekOffset}&age=${currentMinAge}` : `/?week=${currentWeekOffset}`;
            window.history.pushState({ week: currentWeekOffset, age: currentMinAge }, '', newUrl);

            // Reconstruire le contenu HTML des films
            renderFilms(data.films, data.dates);

            // Recharger la watchlist pour colorer les séances déjà ajoutées
            await loadWatchlist();

            container.style.opacity = '1';

            // Réappliquer les filtres et tri sauvegardés
            restoreCinemaPreferences();

            const savedSearch = localStorage.getItem('searchTerm');
            if (savedSearch) {
                document.getElementById('searchInput').value = savedSearch;
                searchFilms();
            }

            const savedSort = localStorage.getItem('sortType');
            if (savedSort) {
                sortFilms(savedSort);
            } else {
                sortFilms('popularity');
            }

            // Restaurer le filtre d'horaire
            const savedTimeSlot = localStorage.getItem('timeSlotFilter');
            if (savedTimeSlot) {
                document.getElementById('timeSlotSelect').value = savedTimeSlot;
                filterByTimeSlot(savedTimeSlot);
            }

            // Restaurer le filtre de jour
            const savedDay = localStorage.getItem('selectedDay');
            if (savedDay) {
                document.getElementById('daySelect').value = savedDay;
                filterByDay(savedDay);
            }

        } catch (error) {
            console.error('Erreur lors du changement de filtre:', error);
            alert('Erreur lors du chargement des données');
            container.style.opacity = '1';
        } finally {
            isLoading = false;
        }
    }

    // Fonction pour changer de semaine dynamiquement
    async function changeWeek(offset) {
        if (isLoading) return;

        isLoading = true;
        currentWeekOffset += offset;

        try {
            const container = document.getElementById('filmsContainer');
            container.style.opacity = '0.5';

            const response = await fetch(`/api/films?week=${currentWeekOffset}&age=${currentMinAge}`);
            const data = await response.json();

            document.getElementById('weekPeriod').innerHTML = `<span class="hidden sm:inline">📅 </span>${data.week_period}`;

            const newUrl = `/?week=${currentWeekOffset}&age=${currentMinAge}`;
            window.history.pushState({ week: currentWeekOffset }, '', newUrl);

            renderFilms(data.films, data.dates);

            // Recharger la watchlist pour colorer les séances déjà ajoutées
            await loadWatchlist();

            // Mettre à jour le bouton "Aujourd'hui"
            updateTodayButton();

            container.style.opacity = '1';

            restoreCinemaPreferences();
            restoreDayPreferences();

            const savedSearch = localStorage.getItem('searchTerm');
            if (savedSearch) {
                document.getElementById('searchInput').value = savedSearch;
                searchFilms();
            }

            const savedSort = localStorage.getItem('sortType');
            if (savedSort) {
                sortFilms(savedSort);
            } else {
                sortFilms('popularity');
            }

            // Restaurer le filtre d'horaire
            const savedTimeSlot = localStorage.getItem('timeSlotFilter');
            if (savedTimeSlot) {
                document.getElementById('timeSlotSelect').value = savedTimeSlot;
                filterByTimeSlot(savedTimeSlot);
            }

            // Restaurer le filtre de jour
            const savedDay = localStorage.getItem('selectedDay');
            if (savedDay) {
                document.getElementById('daySelect').value = savedDay;
                filterByDay(savedDay);
            }

        } catch (error) {
            console.error('Erreur lors du changement de semaine:', error);
            alert('Erreur lors du chargement des données');
            container.style.opacity = '1';
        } finally {
            isLoading = false;
        }
    }

    // Fonction de recherche de films en temps réel
    function searchFilms() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase().trim();

        localStorage.setItem('searchTerm', input.value);

        // Réappliquer tous les filtres (qui incluent maintenant la recherche)
        filterByCinema();

        // Compter les films visibles pour afficher le résultat de recherche
        const filmCards = document.querySelectorAll('.film-mobile-card, .ticket-card');
        const visibleCount = Array.from(filmCards).filter(f => f.style.display !== 'none').length;

        const resultsText = document.getElementById('searchResults');
        if (filter === '') {
            resultsText.textContent = '';
        } else {
            resultsText.textContent = `${visibleCount} film(s) trouvé(s)`;
            resultsText.style.color = visibleCount > 0 ? '#4caf50' : '#f44336';
        }
    }

    // Variables globales pour les filtres
    let currentTimeSlotFilter = 'all';

    // Fonction utilitaire pour vérifier si un horaire est dans une tranche
    function isInTimeSlot(time, slot) {
        // Extraire l'heure (format: "14:30" ou "14h30")
        const hourMatch = time.match(/^(\d{1,2})[h:]?(\d{2})?/);
        if (!hourMatch) return false;

        const hour = parseInt(hourMatch[1]);

        switch (slot) {
            case 'morning':
                return hour < 12;
            case 'afternoon':
                return hour >= 12 && hour < 18;
            case 'evening':
                return hour >= 18 && hour < 22;
            case 'night':
                return hour >= 22;
            default:
                return true;
        }
    }

    // Fonction utilitaire pour vérifier si un jour correspond au filtre
    function isDayInFilter(dayIndex, dayFilter) {
        if (dayFilter === 'all') return true;
        if (dayFilter === 'weekday') return dayIndex >= 0 && dayIndex <= 3; // Lundi à Jeudi
        if (dayFilter === 'weekend') return dayIndex >= 4 && dayIndex <= 6; // Vendredi à Dimanche
        return String(dayIndex) === String(dayFilter); // Jour spécifique
    }

    // Fonction utilitaire pour vérifier si un film a des séances visibles avec tous les filtres
    function filmHasVisibleShowtimes(film, selectedCinemas, versionFilter, timeSlotFilter, dayFilter) {
        if (!film || !film.seances_table) return false;

        // Pour chaque cinéma sélectionné
        for (const cinema of selectedCinemas) {
            const cinemaDays = film.seances_table[cinema];
            if (!cinemaDays) continue;

            // Pour chaque jour
            for (const dayIndex in cinemaDays) {
                const dayIndexNum = parseInt(dayIndex);

                // Vérifier si ce jour correspond au filtre de jour
                if (!isDayInFilter(dayIndexNum, dayFilter)) continue;

                const showtimes = cinemaDays[dayIndex];
                if (!showtimes || showtimes.length === 0) continue;

                // Pour chaque séance de ce jour
                for (const showtime of showtimes) {
                    const time = typeof showtime === 'string' ? showtime : showtime.time;
                    const version = typeof showtime === 'object' && showtime.version ? showtime.version : '';

                    // Vérifier le filtre de version
                    let matchesVersion = true;
                    if (versionFilter === 'VF' && version !== 'VF') {
                        matchesVersion = false;
                    } else if (versionFilter === 'VO' && !version.includes('VO') && !version.includes('VOST')) {
                        matchesVersion = false;
                    }

                    // Vérifier le filtre de créneau horaire
                    let matchesTimeSlot = true;
                    if (timeSlotFilter !== 'all' && !isInTimeSlot(time, timeSlotFilter)) {
                        matchesTimeSlot = false;
                    }

                    // Si cette séance correspond à tous les filtres, le film a au moins une séance visible
                    if (matchesVersion && matchesTimeSlot) {
                        return true;
                    }
                }
            }
        }

        // Aucune séance ne correspond à tous les filtres
        return false;
    }

    // Fonction de filtre par cinéma
    function filterByCinema() {
        const checkboxes = document.querySelectorAll('.ticket-chip input[type="checkbox"]');
        const selectedCinemas = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);

        localStorage.setItem('selectedCinemas', JSON.stringify(selectedCinemas));

        checkboxes.forEach(checkbox => {
            const label = checkbox.closest('.cinema-chip, .ticket-chip');
            if (checkbox.checked) {
                label.classList.add('bg-creme-ecran', 'border-sepia-chaud');
                label.classList.remove('bg-beige-papier', 'border-sepia-chaud/50');
            } else {
                label.classList.remove('bg-creme-ecran', 'border-sepia-chaud');
                label.classList.add('bg-beige-papier', 'border-sepia-chaud/50', 'opacity-60');
            }
        });

        // Récupérer les autres filtres actifs
        const versionFilter = currentVersionFilter || 'all';
        const timeSlotFilter = currentTimeSlotFilter || 'all';
        const dayFilter = localStorage.getItem('selectedDay') || 'all';
        const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();

        // Filtrer les cartes de films (masquer les films sans séances visibles avec TOUS les filtres)
        document.querySelectorAll('.film-mobile-card, .ticket-card').forEach(card => {
            const filmIndex = parseInt(card.dataset.index);
            const film = filmsData[filmIndex];
            const filmTitle = (card.dataset.title || '').toLowerCase();

            // Vérifier le filtre de recherche
            const matchesSearch = searchTerm === '' || filmTitle.includes(searchTerm);

            // Vérifier si le film a au moins une séance visible avec tous les filtres appliqués
            const hasVisibleShowtimes = filmHasVisibleShowtimes(film, selectedCinemas, versionFilter, timeSlotFilter, dayFilter);

            // Afficher seulement si le film correspond à la recherche ET a des séances visibles
            if (matchesSearch && hasVisibleShowtimes) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });

        // Afficher le message "aucun résultat" si nécessaire
        const noResults = document.getElementById('noResults');
        if (noResults) {
            const filmCards = document.querySelectorAll('.film-mobile-card, .ticket-card');
            const visibleFilms = Array.from(filmCards).filter(f => f.style.display !== 'none');
            if (visibleFilms.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }
        }

        updateFilterBadge();
    }

    // Fonction pour tout sélectionner/désélectionner
    function toggleAllCinemas() {
        const checkboxes = document.querySelectorAll('.ticket-chip input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);

        checkboxes.forEach(checkbox => {
            checkbox.checked = !allChecked;
        });

        filterByCinema();
    }

    // Fonction de filtre par jour de la semaine
    function filterByDay(selectedDay) {
        // Sauvegarder dans localStorage
        localStorage.setItem('selectedDay', selectedDay);
        // Réappliquer tous les filtres
        filterByCinema();
        updateFilterBadge();
    }

    // Fonction de filtre par créneau horaire
    function filterByTimeSlot(timeSlot) {
        currentTimeSlotFilter = timeSlot;
        localStorage.setItem('timeSlotFilter', timeSlot);
        // Réappliquer tous les filtres
        filterByCinema();
        updateFilterBadge();
    }

    // Fonction de filtre par version (VO/VF)
    let currentVersionFilter = 'all';

    function filterByVersion(version) {
        currentVersionFilter = version;
        localStorage.setItem('versionFilter', version);
        // Réappliquer tous les filtres
        filterByCinema();
        updateFilterBadge();
    }

    // Restaurer les préférences de cinéma au chargement
    function restoreCinemaPreferences() {
        const savedCinemas = localStorage.getItem('selectedCinemas');

        if (savedCinemas) {
            try {
                const selectedCinemas = JSON.parse(savedCinemas);
                const checkboxes = document.querySelectorAll('.ticket-chip input[type="checkbox"]');

                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });

                checkboxes.forEach(checkbox => {
                    if (selectedCinemas.includes(checkbox.value)) {
                        checkbox.checked = true;
                    }
                });

                filterByCinema();
            } catch (e) {
                console.error('Erreur lors de la restauration des préférences:', e);
            }
        }
    }

    function restoreDayPreferences() {
        const savedDay = localStorage.getItem('selectedDay');

        if (savedDay) {
            try {
                const daySelect = document.getElementById('daySelect');
                if (daySelect) {
                    daySelect.value = savedDay;
                    filterByDay(savedDay);
                }
            } catch (e) {
                console.error('Erreur lors de la restauration des préférences de jours:', e);
            }
        }
    }

    // Variable pour mémoriser le tri actuel
    let currentSort = 'popularity';

    // Fonction de tri des films
    function sortFilms(sortType) {
        const container = document.getElementById('filmsContainer');
        if (!container) return;

        const gridContainer = container.querySelector('.grid');
        if (!gridContainer) return;

        const filmCards = Array.from(gridContainer.querySelectorAll('.film-mobile-card'));

        // Sauvegarder le tri dans localStorage
        localStorage.setItem('sortBy', sortType);
        localStorage.setItem('sortType', sortType);
        currentSort = sortType;

        // Mettre à jour la valeur du select
        const sortSelect = document.getElementById('sortSelect');
        if (sortSelect) sortSelect.value = sortType;

        // Fonction de comparaison
        const compareFunc = (a, b) => {
            switch (sortType) {
                case 'popularity':
                    return parseInt(b.dataset.popularity) - parseInt(a.dataset.popularity);
                case 'alphabetical':
                    return a.dataset.title.localeCompare(b.dataset.title);
                case 'year-desc':
                    return parseInt(b.dataset.year) - parseInt(a.dataset.year);
                case 'year-asc':
                    return parseInt(a.dataset.year) - parseInt(b.dataset.year);
                case 'showtimes':
                    return parseInt(b.dataset.showtimes) - parseInt(a.dataset.showtimes);
                default:
                    return 0;
            }
        };

        // Trier les cartes de films
        filmCards.sort(compareFunc);
        filmCards.forEach(film => gridContainer.appendChild(film));

        // Animation de transition
        gridContainer.style.opacity = '0.7';
        setTimeout(() => {
            gridContainer.style.opacity = '1';
        }, 150);
    }

    // Fonction pour générer le HTML d'un film
    // Fonction pour générer le HTML d'un film
    function renderFilms(films, dates) {
        // Mettre à jour les données globales pour le drawer
        filmsData.length = 0;
        films.forEach(f => filmsData.push(f));
        datesData.length = 0;
        dates.forEach(d => datesData.push(d));

        const container = document.getElementById('filmsContainer');
        if (!container) return;

        const gridContainer = container.querySelector('.grid');
        if (!gridContainer) return;

        if (films.length === 0) {
            gridContainer.innerHTML = '';
            const noResults = document.getElementById('noResults');
            if (noResults) noResults.classList.remove('hidden');
            return;
        }

        // Générer les cartes de films
        gridContainer.innerHTML = films.map((film, index) => `
            <div class="ticket-card vintage-texture spotlight-glow cursor-pointer overflow-hidden" onclick="openFilmDrawer(${index})"
                data-title="${film.title || ''}"
                data-year="${film.releaseYear || 0}"
                data-popularity="${film.wantToSee || 0}"
                data-showtimes="${film.total_showtimes || 0}"
                data-index="${index}">
                <div class="relative">
                    <img src="${film.affiche || ''}" alt="${film.title}"
                        class="w-full h-56 sm:h-64 md:h-72 lg:h-80 object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-noir-velours via-transparent to-transparent opacity-60"></div>
                    <div class="absolute bottom-0 left-0 right-0 p-3">
                        <h2 style="font-family: 'Playfair Display', serif;" class="text-base sm:text-lg font-bold text-creme-ecran drop-shadow-lg line-clamp-2">${film.title}</h2>
                        ${film.releaseYear ? `<p style="font-family: 'Crimson Text', serif;" class="text-xs text-or-antique mt-0.5 italic">${film.releaseYear}</p>` : ''}
                    </div>
                </div>
                <div class="h-2 bg-gradient-to-r from-transparent via-sepia-chaud to-transparent opacity-30"></div>
            </div>
        `).join('');

        const noResults = document.getElementById('noResults');
        if (noResults) noResults.classList.add('hidden');

        // Réappliquer les filtres
        filterByCinema();
    }


    // Gérer le bouton retour du navigateur
    window.addEventListener('popstate', (event) => {
        if (event.state && event.state.week !== undefined) {
            const offset = event.state.week - currentWeekOffset;
            changeWeek(offset);
        }
    });

    // Restaurer les préférences au chargement de la page
    window.addEventListener('load', () => {
        // Restaurer le filtre d'âge
        const savedMinAge = localStorage.getItem('minAge');
        if (savedMinAge !== null) {
            const minAge = parseInt(savedMinAge);
            if (minAge !== currentMinAge) {
                currentMinAge = minAge;
                document.querySelectorAll('.age-filter').forEach(btn => {
                    btn.classList.remove('bg-rouge-cinema', 'text-creme-ecran', 'border-or-antique');
                    btn.classList.add('bg-beige-papier', 'text-noir-velours', 'border-sepia-chaud');
                });
                const activeBtn = document.querySelector(`.age-filter[onclick="changeAgeFilter(${minAge})"]`);
                if (activeBtn) {
                    activeBtn.classList.remove('bg-beige-papier', 'text-noir-velours', 'border-sepia-chaud');
                    activeBtn.classList.add('bg-rouge-cinema', 'text-creme-ecran', 'border-or-antique');
                }
            }
        }

        // Restaurer les préférences de cinéma
        restoreCinemaPreferences();

        // Restaurer les préférences de jours
        restoreDayPreferences();

        // Restaurer la recherche
        const searchInput = document.getElementById('searchInput');
        const savedSearch = localStorage.getItem('searchTerm');
        if (searchInput && savedSearch) {
            searchInput.value = savedSearch;
            searchFilms();
        }

        // Restaurer le tri
        const savedSort = localStorage.getItem('sortType');
        if (savedSort) {
            sortFilms(savedSort);
        }

        // Restaurer le filtre de version
        const savedVersion = localStorage.getItem('versionFilter');
        if (savedVersion) {
            document.getElementById('versionSelect').value = savedVersion;
            filterByVersion(savedVersion);
        }

        // Restaurer le filtre d'horaire
        const savedTimeSlot = localStorage.getItem('timeSlotFilter');
        if (savedTimeSlot) {
            document.getElementById('timeSlotSelect').value = savedTimeSlot;
            filterByTimeSlot(savedTimeSlot);
        }
    });

    // Fonction pour ajouter une séance au calendrier
    async function addToCalendar(filmTitle, cinema, showtimeDate, showtimeTime, filmUrl, filmPoster, showtimeVersion) {
        try {
            const formData = new FormData();
            formData.append('film_title', filmTitle);
            formData.append('cinema', cinema);
            formData.append('showtime_date', showtimeDate);
            formData.append('showtime_time', showtimeTime);
            formData.append('film_url', filmUrl || '');
            formData.append('film_poster', filmPoster || '');
            formData.append('showtime_version', showtimeVersion || '');

            const response = await fetch('/add-to-calendar', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // Afficher une notification de succès
                showNotification('✅ Ajouté à votre calendrier !', 'success');
                // Recharger la watchlist pour mettre à jour les couleurs
                await loadWatchlist();
            } else {
                showNotification('⚠️ ' + data.message, 'warning');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showNotification('❌ Erreur lors de l\'ajout', 'error');
        }
    }

    // Supprimer une séance du calendrier
    async function removeFromCalendar(watchlistId) {
        try {
            const response = await fetch(`/remove-from-calendar/${watchlistId}`, {
                method: 'POST'
            });

            if (response.ok) {
                showNotification('🗑️ Retiré de votre calendrier', 'success');
                // Recharger la watchlist pour mettre à jour les couleurs
                await loadWatchlist();
            } else {
                showNotification('❌ Erreur lors de la suppression', 'error');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showNotification('❌ Erreur lors de la suppression', 'error');
        }
    }

    // Watchlist en mémoire pour coloration rapide
    let userWatchlist = [];

    // Charger la watchlist de l'utilisateur
    async function loadWatchlist() {
        {% if current_user.is_authenticated %}
        try {
            const response = await fetch('/api/my-watchlist');
            if (response.ok) {
                userWatchlist = await response.json();
                colorizeShowtimes();
            }
        } catch (error) {
            console.error('Erreur chargement watchlist:', error);
        }
        {% endif %}
    }

    // Colorer les horaires selon s'ils sont dans le calendrier
    function colorizeShowtimes() {
        document.querySelectorAll('.showtime-slot').forEach(slot => {
            const filmTitle = slot.dataset.film;
            const cinema = slot.dataset.cinema;
            const date = slot.dataset.date;
            const time = slot.dataset.time;

            const isInWatchlist = userWatchlist.some(item =>
                item.film_title === filmTitle &&
                item.cinema === cinema &&
                item.showtime_date === date &&
                item.showtime_time === time
            );

            if (isInWatchlist) {
                // Horaire déjà dans le calendrier → Or antique
                slot.classList.remove('bg-rouge-cinema', 'hover:bg-bordeaux-profond', 'border-or-antique');
                slot.classList.add('bg-or-antique', 'hover:bg-jaune-marquise', 'border-rouge-cinema', 'text-noir-velours');
            } else {
                // Horaire pas dans le calendrier → Rouge cinéma
                slot.classList.remove('bg-or-antique', 'hover:bg-jaune-marquise', 'text-noir-velours');
                slot.classList.add('bg-rouge-cinema', 'hover:bg-bordeaux-profond', 'border-or-antique');
            }
        });
    }

    // Gérer le clic sur un horaire
    async function handleShowtimeClick(filmTitle, cinema, showtimeDate, showtimeTime, filmUrl, filmPoster, showtimeVersion) {
        {% if current_user.is_authenticated %}
        // Vérifier si déjà dans le calendrier
        const existingItem = userWatchlist.find(item =>
            item.film_title === filmTitle &&
            item.cinema === cinema &&
            item.showtime_date === showtimeDate &&
            item.showtime_time === showtimeTime
        );

        if (existingItem) {
            // Supprimer du calendrier
            if (confirm('🗑️ Retirer cette séance de votre calendrier ?')) {
                await removeFromCalendar(existingItem.id);
            }
        } else {
            // Ajouter au calendrier
            await addToCalendar(filmTitle, cinema, showtimeDate, showtimeTime, filmUrl, filmPoster, showtimeVersion);
        }
        {% else %}
        showNotification('🔒 Connectez-vous pour ajouter au calendrier', 'info');
        {% endif %}
    }

    // Fonction pour afficher une notification temporaire
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.fontFamily = "'Crimson Text', serif";
        notification.className = `fixed top-20 right-4 z-50 p-4 rounded-lg shadow-lg border-2 transition-all duration-300 ${type === 'success' ? 'bg-creme-ecran border-rouge-cinema text-noir-velours' :
                type === 'error' ? 'bg-bordeaux-profond border-or-antique text-creme-ecran' :
                    type === 'warning' ? 'bg-jaune-marquise border-sepia-chaud text-noir-velours' :
                        'bg-beige-papier border-sepia-chaud text-noir-velours'
            }`;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Animation d'entrée
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 10);

        // Supprimer après 3 secondes
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100px)';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Charger la watchlist au démarrage
    document.addEventListener('DOMContentLoaded', () => {
        loadWatchlist();
        setupMidnightRefresh();
    });

    // Fonction pour détecter le changement de jour et recharger la page
    function setupMidnightRefresh() {
        // Stocker la date actuelle au chargement de la page
        let currentDate = new Date().toDateString();

        // Vérifier toutes les 30 secondes si on a changé de jour
        setInterval(() => {
            const newDate = new Date().toDateString();

            if (newDate !== currentDate) {
                console.log('🌙 Minuit passé, rechargement de la page pour la nouvelle journée...');

                // Si on est sur la semaine actuelle (week_offset=0), recharger complètement
                if (currentWeekOffset === 0) {
                    // Recharger la page pour récupérer les nouvelles données du jour
                    window.location.reload();
                }

                // Mettre à jour la date de référence
                currentDate = newDate;
            }
        }, 30000); // Vérifier toutes les 30 secondes

        // Vérifier également à la minute exacte de minuit
        const now = new Date();
        const msUntilMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 0) - now;

        setTimeout(() => {
            console.log('🌙 Minuit ! Rechargement de la page...');
            if (currentWeekOffset === 0) {
                window.location.reload();
            }

            // Reconfigurer le timer pour le prochain minuit
            setInterval(() => {
                if (currentWeekOffset === 0) {
                    console.log('🌙 Minuit ! Rechargement de la page...');
                    window.location.reload();
                }
            }, 24 * 60 * 60 * 1000); // Toutes les 24 heures
        }, msUntilMidnight);
    }
</script>

{% endblock %}