{% extends 'base.html' %}

{% block body %}

<!-- Bouton retour en haut -->
<button onclick="scrollToTop()" class="fixed bottom-8 right-8 bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-full shadow-lg transition-all duration-300 hover:scale-110 z-50">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
    </svg>
</button>

<div class="container mx-auto px-4 py-8 max-w-7xl">
    
    <!-- Navigation entre semaines -->
    <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl p-6 mb-6 flex items-center justify-between gap-6">
        <button onclick="changeWeek(-1)" class="flex items-center gap-2 px-5 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 rounded-xl text-white font-medium transition-all duration-200 hover:-translate-x-1">
            ← Semaine précédente
        </button>
        <div id="weekPeriod" class="flex-1 text-center text-xl font-semibold text-white/95 tracking-wide">
            📅 {{ week_period }}
        </div>
        <button onclick="changeWeek(1)" class="flex items-center gap-2 px-5 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 rounded-xl text-white font-medium transition-all duration-200 hover:translate-x-1">
            Semaine suivante →
        </button>
    </div>

    <!-- Filtres et Recherche -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        
        <!-- Recherche et Tri (2/3) -->
        <div class="lg:col-span-2 bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl p-6 space-y-6">
            
            <!-- Recherche -->
            <div>
                <label class="flex items-center gap-2 text-white/90 font-medium mb-3">
                    <span>🔍</span> Recherche
                </label>
                <input type="text" 
                       id="searchInput" 
                       oninput="searchFilms()" 
                       placeholder="Rechercher un film, acteur, réalisateur..." 
                       class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/40 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                <p id="searchResults" class="mt-2 text-sm text-white/50"></p>
            </div>

            <!-- Tri -->
            <div>
                <label class="flex items-center gap-2 text-white/90 font-medium mb-3">
                    <span>📊</span> Trier par
                </label>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <button id="sort-popularity" onclick="sortFilms('popularity')" class="sort-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-white/80 font-medium transition-all duration-200 hover:border-white/20">
                        ⭐ Popularité
                    </button>
                    <button id="sort-alphabetical" onclick="sortFilms('alphabetical')" class="sort-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-white/80 font-medium transition-all duration-200 hover:border-white/20">
                        🔤 A→Z
                    </button>
                    <button id="sort-year-desc" onclick="sortFilms('year-desc')" class="sort-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-white/80 font-medium transition-all duration-200 hover:border-white/20">
                        📅 Récent
                    </button>
                    <button id="sort-year-asc" onclick="sortFilms('year-asc')" class="sort-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-white/80 font-medium transition-all duration-200 hover:border-white/20">
                        📅 Ancien
                    </button>
                    <button id="sort-showtimes" onclick="sortFilms('showtimes')" class="sort-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-white/80 font-medium transition-all duration-200 hover:border-white/20 col-span-2 md:col-span-1">
                        🎬 Séances
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtre Films Classiques (1/3) -->
        <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl p-6">
            <label class="flex items-center gap-2 text-white/90 font-medium mb-4">
                <span>📅</span> Films classiques
            </label>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="changeAgeFilter(0)" class="age-filter px-4 py-3 {% if min_age == 0 %}bg-white text-gray-900 border-white{% else %}bg-white/5 hover:bg-white/10 border-white/10 text-white/80{% endif %} border rounded-xl font-medium transition-all duration-200 hover:border-white/20">
                    Tous
                </button>
                <button onclick="changeAgeFilter(1)" class="age-filter px-4 py-3 {% if min_age == 1 %}bg-white text-gray-900 border-white{% else %}bg-white/5 hover:bg-white/10 border-white/10 text-white/80{% endif %} border rounded-xl font-medium transition-all duration-200 hover:border-white/20">
                    +1 an
                </button>
                <button onclick="changeAgeFilter(5)" class="age-filter px-4 py-3 {% if min_age == 5 %}bg-white text-gray-900 border-white{% else %}bg-white/5 hover:bg-white/10 border-white/10 text-white/80{% endif %} border rounded-xl font-medium transition-all duration-200 hover:border-white/20">
                    +5 ans
                </button>
                <button onclick="changeAgeFilter(30)" class="age-filter px-4 py-3 {% if min_age == 30 %}bg-white text-gray-900 border-white{% else %}bg-white/5 hover:bg-white/10 border-white/10 text-white/80{% endif %} border rounded-xl font-medium transition-all duration-200 hover:border-white/20">
                    +30 ans
                </button>
            </div>
        </div>
    </div>

    <!-- Filtre par Cinéma -->
    <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl p-6 mb-8">
        <label class="flex items-center gap-2 text-white/90 font-medium mb-4">
            <span>🎭</span> Filtrer par cinéma
        </label>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
            <label class="cinema-checkbox-label flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="Les Studios" checked onchange="filterByCinema()" class="w-5 h-5 rounded accent-indigo-500">
                <span class="cinema-name text-white/90 font-medium text-sm">Les Studios</span>
            </label>
            <label class="cinema-checkbox-label flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="CGR Brest Le Celtic" checked onchange="filterByCinema()" class="w-5 h-5 rounded accent-indigo-500">
                <span class="cinema-name text-white/90 font-medium text-sm">CGR Brest Le Celtic</span>
            </label>
            <label class="cinema-checkbox-label flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="Multiplexe Liberté" checked onchange="filterByCinema()" class="w-5 h-5 rounded accent-indigo-500">
                <span class="cinema-name text-white/90 font-medium text-sm">Multiplexe Liberté</span>
            </label>
            <label class="cinema-checkbox-label flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="Pathé Capucins" checked onchange="filterByCinema()" class="w-5 h-5 rounded accent-indigo-500">
                <span class="cinema-name text-white/90 font-medium text-sm">Pathé Capucins</span>
            </label>
            <label class="cinema-checkbox-label flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl cursor-pointer transition-all duration-200 hover:border-white/20">
                <input type="checkbox" value="Ciné Galaxy" checked onchange="filterByCinema()" class="w-5 h-5 rounded accent-indigo-500">
                <span class="cinema-name text-white/90 font-medium text-sm">Ciné Galaxy</span>
            </label>
        </div>
    </div>

    <!-- Liste des films -->
    <div id="filmsContainer" class="space-y-8 transition-opacity duration-200">
    {% for film in films %}
    <div class="film-item bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden hover:border-white/20 transition-all duration-300" 
         data-title="{{ film.title }}" 
         data-year="{{ film.releaseYear or 0 }}"
         data-popularity="{{ film.wantToSee or 0 }}"
         data-showtimes="{{ film.total_showtimes or 0 }}">
        
        <!-- En-tête du film -->
        <div class="flex flex-col md:flex-row gap-6 p-6">
            <img src="{{ film.affiche }}" alt="{{ film.title }}" class="w-full md:w-48 h-auto rounded-xl shadow-lg object-cover">
            
            <div class="flex-1 space-y-4">
                <div>
                    <h3 class="text-2xl md:text-3xl font-bold text-white mb-2">
                        <a href="{{ film.url }}" class="hover:text-indigo-400 transition">{{ film.title }}</a>
                        {% if film.releaseYear %}
                        <span class="text-base text-white/40 font-normal ml-2">({{ film.releaseYear }})</span>
                        {% endif %}
                    </h3>
                    {% if film.releaseYear and film.filmAge %}
                    <span class="inline-flex items-center gap-2 bg-white/10 text-white/70 px-3 py-1.5 rounded-lg text-sm font-medium border border-white/10">
                        <span class="opacity-60">📅</span> Il y a {{ film.filmAge }} ans
                    </span>
                    {% endif %}
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <p class="text-white/70"><span class="font-semibold text-white/90">Réalisateur:</span> {{ film.director }}</p>
                    <p class="text-white/70"><span class="font-semibold text-white/90">Durée:</span> {{ film.duree }}</p>
                    <p class="text-white/70 col-span-2"><span class="font-semibold text-white/90">Genre:</span> {{ film.genres }}</p>
                    <p class="text-white/70 col-span-2"><span class="font-semibold text-white/90">Casting:</span> {{ film.casting }}</p>
                </div>
                
                {% if film.synopsis %}
                <p class="text-white/60 text-sm leading-relaxed line-clamp-3">{{ film.synopsis }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Tableau des séances -->
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-white/5">
                        <th class="px-4 py-4 text-left text-white/90 font-semibold border-r border-white/10 text-sm">Cinéma</th>
                        {% for date in dates %}
                        <th class="px-3 py-4 text-center border-r border-white/5">
                            <div class="text-white/50 text-xs font-normal">{{ date.jour }}</div>
                            <div class="text-xl font-bold text-white/90 my-1">{{ date.chiffre }}</div>
                            <div class="text-white/50 text-xs font-normal">{{ date.mois }}</div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for cinema_name, days_data in film.seances_table.items() %}
                    <tr class="cinema-row border-t border-white/5 hover:bg-white/5 transition" data-cinema="{{ cinema_name }}">
                        <td class="px-4 py-3 text-white/85 font-medium border-r border-white/10 whitespace-nowrap text-sm">
                            {{ cinema_name }}
                        </td>
                        {% for date in dates %}
                        <td class="px-2 py-3 text-center border-r border-white/5">
                            {% if date.index in days_data %}
                            <div class="flex flex-wrap gap-1.5 justify-center">
                                {% for time in days_data[date.index] %}
                                <span class="bg-white/15 hover:bg-white/20 text-white px-2.5 py-1 rounded-lg text-xs font-medium border border-white/20 whitespace-nowrap transition">{{ time }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="text-white/20 text-sm">—</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
    </div>

</div>

<script>
// Fonction pour remonter en haut avec défilement smooth
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Variable globale pour suivre la semaine actuelle
let currentWeekOffset = {{ week_offset }};
let currentMinAge = {{ min_age }};
let isLoading = false;

// Fonction pour changer le filtre d'âge dynamiquement
async function changeAgeFilter(minAge) {
    if (isLoading) return;
    
    isLoading = true;
    currentMinAge = minAge;
    
    // Sauvegarder le filtre d'âge dans localStorage
    localStorage.setItem('minAge', minAge);
    
    try {
        const container = document.getElementById('filmsContainer');
        container.style.opacity = '0.5';
        
        // Mettre à jour l'apparence des boutons
        document.querySelectorAll('.age-filter').forEach(btn => {
            btn.classList.remove('bg-white', 'text-gray-900', 'border-white');
            btn.classList.add('bg-white/5', 'text-white/80', 'border-white/10');
        });
        event.target.classList.remove('bg-white/5', 'text-white/80', 'border-white/10');
        event.target.classList.add('bg-white', 'text-gray-900', 'border-white');
        
        // Récupérer les données via l'API
        const response = await fetch(`/api/films?week=${currentWeekOffset}&age=${currentMinAge}`);
        const data = await response.json();
        
        // Mettre à jour l'URL sans recharger la page
        const newUrl = currentMinAge > 0 ? `/?week=${currentWeekOffset}&age=${currentMinAge}` : `/?week=${currentWeekOffset}`;
        window.history.pushState({week: currentWeekOffset, age: currentMinAge}, '', newUrl);
        
        // Reconstruire le contenu HTML des films
        renderFilms(data.films, data.dates);
        
        container.style.opacity = '1';
        
        // Réappliquer les filtres et tri sauvegardés
        restoreCinemaPreferences();
        
        const savedSearch = localStorage.getItem('searchTerm');
        if (savedSearch) {
            document.getElementById('searchInput').value = savedSearch;
            searchFilms();
        }
        
        const savedSort = localStorage.getItem('sortType');
        if (savedSort) {
            sortFilms(savedSort);
        } else {
            sortFilms('popularity');
        }
        
    } catch (error) {
        console.error('Erreur lors du changement de filtre:', error);
        alert('Erreur lors du chargement des données');
        container.style.opacity = '1';
    } finally {
        isLoading = false;
    }
}

// Fonction pour changer de semaine dynamiquement
async function changeWeek(offset) {
    if (isLoading) return;
    
    isLoading = true;
    currentWeekOffset += offset;
    
    try {
        const container = document.getElementById('filmsContainer');
        container.style.opacity = '0.5';
        
        const response = await fetch(`/api/films?week=${currentWeekOffset}&age=${currentMinAge}`);
        const data = await response.json();
        
        document.getElementById('weekPeriod').textContent = `📅 ${data.week_period}`;
        
        const newUrl = `/?week=${currentWeekOffset}&age=${currentMinAge}`;
        window.history.pushState({week: currentWeekOffset}, '', newUrl);
        
        renderFilms(data.films, data.dates);
        
        container.style.opacity = '1';
        
        restoreCinemaPreferences();
        
        const savedSearch = localStorage.getItem('searchTerm');
        if (savedSearch) {
            document.getElementById('searchInput').value = savedSearch;
            searchFilms();
        }
        
        const savedSort = localStorage.getItem('sortType');
        if (savedSort) {
            sortFilms(savedSort);
        } else {
            sortFilms('popularity');
        }
        
    } catch (error) {
        console.error('Erreur lors du changement de semaine:', error);
        alert('Erreur lors du chargement des données');
        container.style.opacity = '1';
    } finally {
        isLoading = false;
    }
}

// Fonction de recherche de films en temps réel
function searchFilms() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase().trim();
    const filmItems = document.querySelectorAll('.film-item');
    const resultsText = document.getElementById('searchResults');
    
    localStorage.setItem('searchTerm', input.value);
    
    let visibleCount = 0;
    
    filmItems.forEach(filmItem => {
        const filmText = filmItem.textContent.toLowerCase();
        
        if (filter === '' || filmText.includes(filter)) {
            filmItem.style.display = '';
            visibleCount++;
        } else {
            filmItem.style.display = 'none';
        }
    });
    
    if (filter === '') {
        resultsText.textContent = '';
    } else {
        resultsText.textContent = `${visibleCount} film(s) trouvé(s)`;
        resultsText.style.color = visibleCount > 0 ? '#4caf50' : '#f44336';
    }
}

// Fonction de filtre par cinéma
function filterByCinema() {
    const checkboxes = document.querySelectorAll('.cinema-checkbox-label input[type="checkbox"]');
    const selectedCinemas = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    localStorage.setItem('selectedCinemas', JSON.stringify(selectedCinemas));
    
    checkboxes.forEach(checkbox => {
        const label = checkbox.closest('.cinema-checkbox-label');
        if (checkbox.checked) {
            label.classList.add('bg-white/15', 'border-white/30');
        } else {
            label.classList.remove('bg-white/15', 'border-white/30');
        }
    });
    
    document.querySelectorAll('.cinema-row').forEach(row => {
        const cinemaName = row.dataset.cinema;
        if (selectedCinemas.includes(cinemaName)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    document.querySelectorAll('.film-item').forEach(filmItem => {
        const visibleRows = filmItem.querySelectorAll('.cinema-row:not([style*="display: none"])');
        
        if (visibleRows.length === 0) {
            filmItem.style.display = 'none';
        } else {
            filmItem.style.display = '';
        }
    });
}

// Restaurer les préférences de cinéma au chargement
function restoreCinemaPreferences() {
    const savedCinemas = localStorage.getItem('selectedCinemas');
    
    if (savedCinemas) {
        try {
            const selectedCinemas = JSON.parse(savedCinemas);
            const checkboxes = document.querySelectorAll('.cinema-checkbox-label input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            checkboxes.forEach(checkbox => {
                if (selectedCinemas.includes(checkbox.value)) {
                    checkbox.checked = true;
                }
            });
            
            filterByCinema();
        } catch (e) {
            console.error('Erreur lors de la restauration des préférences:', e);
        }
    }
}

// Variable pour mémoriser le tri actuel
let currentSort = 'popularity';

// Fonction de tri des films
function sortFilms(sortType) {
    const container = document.getElementById('filmsContainer');
    const films = Array.from(container.querySelectorAll('.film-item'));
    
    localStorage.setItem('sortType', sortType);
    
    document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-600', 'border-indigo-500');
        btn.classList.add('bg-white/5', 'border-white/10');
    });
    const activeBtn = document.getElementById(`sort-${sortType}`);
    activeBtn.classList.remove('bg-white/5', 'border-white/10');
    activeBtn.classList.add('bg-indigo-600', 'border-indigo-500');
    
    currentSort = sortType;
    
    films.sort((a, b) => {
        switch(sortType) {
            case 'popularity':
                return parseInt(b.dataset.popularity) - parseInt(a.dataset.popularity);
            
            case 'alphabetical':
                return a.dataset.title.localeCompare(b.dataset.title);
            
            case 'year-desc':
                return parseInt(b.dataset.year) - parseInt(a.dataset.year);
            
            case 'year-asc':
                return parseInt(a.dataset.year) - parseInt(b.dataset.year);
            
            case 'showtimes':
                return parseInt(b.dataset.showtimes) - parseInt(a.dataset.showtimes);
            
            default:
                return 0;
        }
    });
    
    films.forEach(film => container.appendChild(film));
    
    container.style.opacity = '0.7';
    setTimeout(() => {
        container.style.opacity = '1';
    }, 150);
}

// Fonction pour générer le HTML d'un film
function renderFilms(films, dates) {
    const container = document.getElementById('filmsContainer');
    
    if (films.length === 0) {
        container.innerHTML = '<div class="text-center py-16 text-white/60">Aucun film trouvé pour cette semaine</div>';
        return;
    }
    
    container.innerHTML = films.map(film => {
        const datesHeader = dates.map(date => `
            <th class="px-3 py-4 text-center border-r border-white/5">
                <div class="text-white/50 text-xs font-normal">${date.jour}</div>
                <div class="text-xl font-bold text-white/90 my-1">${date.chiffre}</div>
                <div class="text-white/50 text-xs font-normal">${date.mois}</div>
            </th>
        `).join('');
        
        let seancesHTML = '';
        for (const [cinema, days] of Object.entries(film.seances_table || {})) {
            seancesHTML += `
                <tr class="cinema-row border-t border-white/5 hover:bg-white/5 transition" data-cinema="${cinema}">
                    <td class="px-4 py-3 text-white/85 font-medium border-r border-white/10 whitespace-nowrap text-sm">
                        ${cinema}
                    </td>`;
            
            for (let i = 0; i < 7; i++) {
                const times = days[i] || [];
                if (times.length > 0) {
                    seancesHTML += `
                        <td class="px-2 py-3 text-center border-r border-white/5">
                            <div class="flex flex-wrap gap-1.5 justify-center">
                                ${times.map(time => `<span class="bg-white/15 hover:bg-white/20 text-white px-2.5 py-1 rounded-lg text-xs font-medium border border-white/20 whitespace-nowrap transition">${time}</span>`).join('')}
                            </div>
                        </td>`;
                } else {
                    seancesHTML += `<td class="px-2 py-3 text-center border-r border-white/5"><span class="text-white/20 text-sm">—</span></td>`;
                }
            }
            seancesHTML += '</tr>';
        }
        
        const filmAge = film.filmAge || '';
        const releaseYear = film.releaseYear || '';
        
        return `
            <div class="film-item bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden hover:border-white/20 transition-all duration-300" 
                 data-title="${film.title || ''}" 
                 data-year="${releaseYear}"
                 data-popularity="${film.wantToSee || 0}"
                 data-showtimes="${film.total_showtimes || 0}">
                
                <div class="flex flex-col md:flex-row gap-6 p-6">
                    <img src="${film.affiche || ''}" alt="${film.title}" class="w-full md:w-48 h-auto rounded-xl shadow-lg object-cover">
                    
                    <div class="flex-1 space-y-4">
                        <div>
                            <h3 class="text-2xl md:text-3xl font-bold text-white mb-2">
                                <a href="${film.url || '#'}" class="hover:text-indigo-400 transition">${film.title || ''}</a>
                                ${releaseYear ? `<span class="text-base text-white/40 font-normal ml-2">(${releaseYear})</span>` : ''}
                            </h3>
                            ${releaseYear && filmAge ? `
                            <span class="inline-flex items-center gap-2 bg-white/10 text-white/70 px-3 py-1.5 rounded-lg text-sm font-medium border border-white/10">
                                <span class="opacity-60">📅</span> Il y a ${filmAge} ans
                            </span>
                            ` : ''}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <p class="text-white/70"><span class="font-semibold text-white/90">Réalisateur:</span> ${film.director || 'N/A'}</p>
                            <p class="text-white/70"><span class="font-semibold text-white/90">Durée:</span> ${film.duree || 'N/A'}</p>
                            <p class="text-white/70 col-span-2"><span class="font-semibold text-white/90">Genre:</span> ${film.genres || 'N/A'}</p>
                            <p class="text-white/70 col-span-2"><span class="font-semibold text-white/90">Casting:</span> ${film.casting || 'N/A'}</p>
                        </div>
                        
                        ${film.synopsis ? `<p class="text-white/60 text-sm leading-relaxed line-clamp-3">${film.synopsis}</p>` : ''}
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-white/5">
                                <th class="px-4 py-4 text-left text-white/90 font-semibold border-r border-white/10 text-sm">Cinéma</th>
                                ${datesHeader}
                            </tr>
                        </thead>
                        <tbody>
                            ${seancesHTML}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }).join('');
}

// Gérer le bouton retour du navigateur
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.week !== undefined) {
        const offset = event.state.week - currentWeekOffset;
        changeWeek(offset);
    }
});

// Restaurer les préférences au chargement de la page
window.addEventListener('load', () => {
    // Restaurer le filtre d'âge
    const savedMinAge = localStorage.getItem('minAge');
    if (savedMinAge !== null) {
        const minAge = parseInt(savedMinAge);
        if (minAge !== currentMinAge) {
            currentMinAge = minAge;
            document.querySelectorAll('.age-filter').forEach(btn => {
                btn.classList.remove('bg-white', 'text-gray-900', 'border-white');
                btn.classList.add('bg-white/5', 'text-white/80', 'border-white/10');
            });
            const activeBtn = document.querySelector(`.age-filter[onclick="changeAgeFilter(${minAge})"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-white/5', 'text-white/80', 'border-white/10');
                activeBtn.classList.add('bg-white', 'text-gray-900', 'border-white');
            }
        }
    }
    
    // Restaurer les préférences de cinéma
    restoreCinemaPreferences();
    
    // Restaurer la recherche
    const searchInput = document.getElementById('searchInput');
    const savedSearch = localStorage.getItem('searchTerm');
    if (searchInput && savedSearch) {
        searchInput.value = savedSearch;
        searchFilms();
    }
    
    // Restaurer le tri
    const savedSort = localStorage.getItem('sortType');
    if (savedSort) {
        sortFilms(savedSort);
    }
});
</script>

{% endblock %}
